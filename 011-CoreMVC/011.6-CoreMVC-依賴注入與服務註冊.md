---
title: 🧩 011.6-CoreMVC-依賴注入與服務註冊
tags:
  - ASP-NET
  - Core
  - MVC
  - 依賴注入
  - DI
  - 服務註冊
aliases:
  - CoreMVC DI
  - ASP.NET Core 依賴注入
created: 2025-07-02
updated: 2025-07-02
status: 草稿
summary: 介紹 ASP.NET Core MVC 的依賴注入（DI）原理、服務註冊方式、生命週期與實務應用，協助開發高可維護性與可測試性的現代應用。
---

## 🧩 依賴注入（Dependency Injection, DI）概念

- **依賴注入**是 ASP.NET Core 內建的設計模式，將服務（Service）或元件的建立與管理交由框架處理，提升模組化、可維護性與可測試性。
- 常見應用：資料存取層、業務邏輯層、第三方服務、設定管理等。

---
## 🛠️ 服務註冊方式

- 於 `Program.cs`（.NET 6+）或 `Startup.cs` 的 `ConfigureServices` 方法中註冊服務。

```csharp
// 介面與實作  
public interface IProductService  
{  
	IEnumerable<Product> GetAll();  
}

public class ProductService : IProductService  
{  
	public IEnumerable<Product> GetAll() { ... }  
}

// 註冊服務  
builder.Services.AddScoped<IProductService, ProductService>();
```

### 常用生命週期

| 方法         | 生命週期           | 說明                         |
|:------------|:------------------|:----------------------------|
| AddSingleton| 單一實例           | 應用程式存續期間只建立一次    |
| AddScoped   | 範圍實例           | 每個 HTTP 請求建立一次       |
| AddTransient| 瞬時實例           | 每次取得都建立新實例         |

---
## 🧬 服務注入用法

- 於 Controller、Service、Middleware 等類別建構函式注入服務：

```csharp
public class ProductController : Controller  
{  
	private readonly IProductService _service;
	public ProductController(IProductService service)
	{
	    _service = service;
	}
	
	public IActionResult Index()
	{
	    var products = _service.GetAll();
	    return View(products);
	}
}
```

- 支援多層注入、介面導向設計，方便單元測試與 Mock。

---
## 🏗️ 內建與第三方服務註冊

- ASP.NET Core 內建多種服務註冊方法（如資料庫、Identity、快取、HttpClient 等）：

```csharp
builder.Services.AddDbContext<AppDbContext>(options =>  
options.UseSqlServer("連線字串"));

builder.Services.AddMemoryCache();  
builder.Services.AddHttpClient();
```

- 可註冊自訂服務、第三方函式庫（如 AutoMapper、Serilog、Swagger 等）。

---
## ⚠️ 常見問題與實務建議

- **避免直接 new 實例**，應統一由 DI 容器管理。
- **生命週期選擇**：資料庫連線建議用 Scoped，輕量服務可用 Singleton。
- **循環依賴**：設計時避免服務間相互依賴造成無限循環。
- **測試便利性**：介面導向設計可輕鬆替換 Mock 實作進行單元測試。

---
## 🔗 相關卡片

- [[011.5-CoreMVC-表單處理與驗證]]
- [[011.7-CoreMVC-與資料庫整合 (EF Core)]]
- [[011.8-CoreMVC-分層架構與專案實務設計]]
