---
title: ğŸ—„ï¸ 011.7-CoreMVC-èˆ‡è³‡æ–™åº«æ•´åˆ (EF Core)
tags:
  - ASP-NET
  - Core
  - MVC
  - EF
  - Core
  - è³‡æ–™åº«
  - ORM
aliases:
  - CoreMVC è³‡æ–™åº«
  - Entity Framework Core
created: 2025-07-02
updated: 2025-07-02
status: è‰ç¨¿
summary: ä»‹ç´¹ ASP.NET Core MVC èˆ‡ Entity Framework Core (EF Core) çš„æ•´åˆæµç¨‹ï¼Œæ¶µè“‹å®‰è£ã€è¨­å®šã€è³‡æ–™æ¨¡å‹è¨­è¨ˆã€DbContextã€è³‡æ–™åº«é·ç§»èˆ‡ CRUD æ“ä½œã€‚
---

åœ¨ ASP.NET Core MVC æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œèˆ‡è³‡æ–™åº«äº’å‹•æ˜¯æ ¸å¿ƒéœ€æ±‚ã€‚**Entity Framework Core (EF Core)** æ˜¯ Microsoft æ¨è–¦çš„**ç‰©ä»¶é—œè¯å°æ‡‰ (ORM - Object-Relational Mapper)** æ¡†æ¶ï¼Œå®ƒå…è¨±é–‹ç™¼è€…ä½¿ç”¨ .NET ç‰©ä»¶ï¼ˆä¹Ÿå°±æ˜¯ C# é¡åˆ¥ï¼‰ä¾†æŸ¥è©¢ã€å»ºç«‹ã€æ›´æ–°å’Œåˆªé™¤è³‡æ–™åº«ä¸­çš„è³‡æ–™ï¼Œè€Œç„¡éœ€ç›´æ¥ç·¨å¯« SQL èªå¥ã€‚é€™æ¥µå¤§åœ°ç°¡åŒ–äº†è³‡æ–™å­˜å–å±¤çš„é–‹ç™¼å’Œç¶­è­·ã€‚

æœ¬ç­†è¨˜å°‡ä¸»è¦èšç„¦æ–¼ **Code-First** é–‹ç™¼æ¨¡å¼ï¼Œå³å¾ C# è³‡æ–™æ¨¡å‹ç”Ÿæˆè³‡æ–™åº«çµæ§‹ã€‚

---

## ğŸ—„ï¸ EF Core èˆ‡ ASP.NET Core MVC æ•´åˆæ¦‚è¿°

EF Core æ‰®æ¼”äº†æ‡‰ç”¨ç¨‹å¼å’Œé—œè¯å¼è³‡æ–™åº«ä¹‹é–“çš„**æ©‹æ¨‘**ã€‚å®ƒæŠ½è±¡åŒ–äº†åº•å±¤çš„è³‡æ–™åº«æ“ä½œï¼Œè®“é–‹ç™¼è€…å¯ä»¥å°ˆæ³¨æ–¼æ‡‰ç”¨ç¨‹å¼çš„æ¥­å‹™é‚è¼¯ã€‚

**ä¸»è¦å„ªå‹¢ï¼š**

- **ç‰©ä»¶å°å‘æ“ä½œ**ï¼šä»¥ LINQ æŸ¥è©¢å’Œ C# ç‰©ä»¶é€²è¡Œè³‡æ–™æ“ä½œï¼Œç›´è§€ä¸”é¡å‹å®‰å…¨ã€‚

- **è·¨è³‡æ–™åº«æ”¯æ´**ï¼šé€éä¸åŒçš„è³‡æ–™åº«æä¾›è€… (Providers) æ”¯æ´å¤šç¨®è³‡æ–™åº«ç³»çµ±ï¼Œå¦‚ SQL Serverã€SQLiteã€PostgreSQLã€MySQL ç­‰ã€‚

- **è³‡æ–™åº«é·ç§» (Migrations)**ï¼šæä¾›ä¸€å¥—å¼·å¤§çš„å·¥å…·ä¾†ç®¡ç†è³‡æ–™åº«çµæ§‹çš„æ¼”é€²ï¼Œèƒ½å¤ æ ¹æ“š C# Model çš„è®ŠåŒ–è‡ªå‹•ç”Ÿæˆå’Œæ‡‰ç”¨è³‡æ–™åº«è…³æœ¬ã€‚

- **å…§å»º DI æ”¯æ´**ï¼šèˆ‡ ASP.NET Core çš„ä¾è³´æ³¨å…¥å®¹å™¨ç„¡ç¸«æ•´åˆã€‚

---
## ğŸ› ï¸ æ•´åˆæ­¥é©Ÿèˆ‡åŸºæœ¬æµç¨‹

å°‡ EF Core æ•´åˆåˆ° ASP.NET Core MVC æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œé€šå¸¸éµå¾ªä»¥ä¸‹æ­¥é©Ÿï¼š

### 1. å®‰è£ EF Core å¥—ä»¶

é¦–å…ˆï¼Œéœ€è¦åœ¨å°ˆæ¡ˆä¸­å®‰è£å°æ‡‰çš„ NuGet å¥—ä»¶ã€‚é€™å¯ä»¥é€é Visual Studio çš„ NuGet å¥—ä»¶ç®¡ç†å™¨æˆ– .NET CLI å®Œæˆã€‚

- **è³‡æ–™åº«æä¾›è€…å¥—ä»¶** (ä¾‹å¦‚ SQL Server)ï¼š
```csharp
dotnet add package Microsoft.EntityFrameworkCore.SqlServer
```
 (å¦‚æœä½¿ç”¨å…¶ä»–è³‡æ–™åº«ï¼Œå‰‡å®‰è£å°æ‡‰çš„å¥—ä»¶ï¼Œä¾‹å¦‚ `Microsoft.EntityFrameworkCore.Sqlite` æˆ– `Npgsql.EntityFrameworkCore.PostgreSQL`)

- **EF Core å·¥å…·å¥—ä»¶** (ç”¨æ–¼ Migration)ï¼š
```csharp
dotnet add package Microsoft.EntityFrameworkCore.Tools
```
é€™å€‹å¥—ä»¶åŒ…å«äº†ç”¨æ–¼åŸ·è¡Œ `Add-Migration` å’Œ `Update-Database` ç­‰å‘½ä»¤çš„å·¥å…·ã€‚

### 2. è¨­è¨ˆè³‡æ–™æ¨¡å‹ï¼ˆModelï¼‰

åœ¨ `Models/` è³‡æ–™å¤¾ï¼ˆæˆ–ä»»ä½•ä½ åå¥½çš„è³‡æ–™æ¨¡å‹è³‡æ–™å¤¾ï¼‰ä¸­å»ºç«‹ C# é¡åˆ¥ã€‚é€™äº›é¡åˆ¥çš„å¯¦ä¾‹å°‡ä»£è¡¨è³‡æ–™åº«ä¸­çš„ä¸€è¡Œè³‡æ–™ï¼ˆä¸€å€‹å¯¦é«”ï¼‰ã€‚

```csharp
// Models/Employee.cs
using System.ComponentModel.DataAnnotations; // å¼•å…¥è³‡æ–™è¨»è§£å‘½åç©ºé–“
using System.ComponentModel.DataAnnotations.Schema; // å¼•å…¥ Schema ç›¸é—œçš„è³‡æ–™è¨»è§£

public class Employee
{
    // [Key] // å¯é¸ï¼šå¦‚æœå±¬æ€§åç‚º Id æˆ– <ClassName>Idï¼ŒEF Core æœƒè‡ªå‹•å°‡å…¶è¦–ç‚ºä¸»éµ
    public int Id { get; set; }

    [Required(ErrorMessage = "å“¡å·¥å§“åç‚ºå¿…å¡«ã€‚")] // è³‡æ–™è¨»è§£ï¼šè¨­å®šç‚ºå¿…å¡«æ¬„ä½ (å°æ‡‰è³‡æ–™åº« Not Null)
    [StringLength(100, ErrorMessage = "å§“åé•·åº¦ä¸èƒ½è¶…é 100 å€‹å­—å…ƒã€‚")] // è¨­å®šå­—ä¸²æœ€å¤§é•·åº¦
    public string Name { get; set; }

    [Required(ErrorMessage = "è·ç¨±ç‚ºå¿…å¡«ã€‚")]
    [Column("JobTitle", TypeName = "nvarchar(50)")] // Fluent API æ›¿ä»£æ–¹æ¡ˆï¼šæŒ‡å®šè³‡æ–™åº«æ¬„ä½åç¨±å’Œé¡å‹
    public string Designation { get; set; }

    public DateTime HireDate { get; set; } = DateTime.Now; // è¨­å®šé è¨­å€¼

    // å°è¦½å±¬æ€§ (Navigation Property)ï¼šè¡¨ç¤ºé—œè¯é—œä¿‚
    // public ICollection<Order> Orders { get; set; } // å¦‚æœä¸€å€‹å“¡å·¥å¯ä»¥æœ‰å¤šå€‹è¨‚å–®
}
```

- **è³‡æ–™è¨»è§£ (Data Annotations)**ï¼šç”¨æ–¼ç‚º Model å±¬æ€§å®šç¾©è³‡æ–™åº«æ˜ å°„è¦å‰‡å’Œé©—è­‰è¦å‰‡ï¼ˆä¾‹å¦‚ `[Required]`ã€`[StringLength]`ã€`[Key]`ã€`[Table]`ã€`[Column]` ç­‰ï¼‰ã€‚

- **Fluent API (åœ¨ `DbContext` ä¸­é…ç½®)**ï¼šå°æ–¼æ›´è¤‡é›œæˆ–ä¸é©åˆç”¨è³‡æ–™è¨»è§£è¡¨é”çš„æ˜ å°„è¦å‰‡ï¼ˆä¾‹å¦‚è¤‡åˆä¸»éµã€å¤šå°å¤šé—œä¿‚ã€æ›´ç´°ç·»çš„ç´„æŸï¼‰ï¼Œå¯ä»¥åœ¨ `DbContext` ä¸­é‡å¯« `OnModelCreating` æ–¹æ³•ä¾†ä½¿ç”¨ Fluent API é€²è¡Œé…ç½®ã€‚

### 3. å»ºç«‹ DbContext é¡åˆ¥

**`DbContext`** æ˜¯ EF Core ä¸­æœ€é‡è¦çš„é¡åˆ¥ï¼Œå®ƒä»£è¡¨äº†èˆ‡è³‡æ–™åº«çš„æœƒè©± (session)ã€‚å®ƒè² è²¬ï¼š

- ç®¡ç†è³‡æ–™åº«é€£ç·šã€‚
- è¿½è¹¤å¯¦é«”çš„ç‹€æ…‹è®ŠåŒ– (ä¾‹å¦‚æ–°å¢ã€ä¿®æ”¹ã€åˆªé™¤)ã€‚
- åŸ·è¡Œ LINQ æŸ¥è©¢ä¸¦å°‡çµæœæ˜ å°„ç‚º C# ç‰©ä»¶ã€‚
- å°‡ C# ç‰©ä»¶çš„è®ŠåŒ–æŒä¹…åŒ–åˆ°è³‡æ–™åº«ã€‚
- å®ƒåŒæ™‚æ‰®æ¼”è‘—**å·¥ä½œå–®å…ƒ (Unit of Work)** å’Œ**å€‰å„² (Repository)** çš„è§’è‰²ã€‚

```csharp
// Data/ApplicationDbContext.cs (å»ºè­°æ”¾åœ¨å°ˆæ¡ˆçš„ Data/ è³‡æ–™å¤¾)
using Microsoft.EntityFrameworkCore;

public class ApplicationDbContext : DbContext
{
    // å»ºæ§‹å‡½å¼ï¼šæ¥æ”¶ DbContextOptionsï¼Œç”¨æ–¼é…ç½®è³‡æ–™åº«æä¾›è€…å’Œé€£ç·šå­—ä¸²
    public ApplicationDbContext(DbContextOptions<ApplicationDbContext> options)
        : base(options)
    {
    }

    // DbSet<TEntity> å±¬æ€§ï¼šæ¯å€‹ DbSet å°æ‡‰è³‡æ–™åº«ä¸­çš„ä¸€å€‹è³‡æ–™è¡¨
    public DbSet<Employee> Employees { get; set; }
    // public DbSet<Product> Products { get; set; } // å¦‚æœæœ‰å…¶ä»–æ¨¡å‹

    // å¯é¸ï¼šé‡å¯« OnModelCreating ä»¥ä½¿ç”¨ Fluent API é€²è¡Œæ›´è©³ç´°çš„æ¨¡å‹é…ç½®
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);

        // ç¯„ä¾‹ï¼šä½¿ç”¨ Fluent API é…ç½® Employee çš„ Designation å±¬æ€§
        // modelBuilder.Entity<Employee>()
        //     .Property(e => e.Designation)
        //     .HasColumnName("JobTitle") // æ˜ å°„åˆ°è³‡æ–™åº«æ¬„ä½å JobTitle
        //     .HasMaxLength(50) // è¨­å®šæœ€å¤§é•·åº¦
        //     .IsRequired(); // è¨­å®šç‚ºå¿…å¡«
        
        // ç¯„ä¾‹ï¼šé…ç½®è¤‡åˆä¸»éµ
        // modelBuilder.Entity<OrderLine>()
        //     .HasKey(ol => new { ol.OrderId, ol.ProductId });
    }
}
```

### 4. è¨­å®šè³‡æ–™åº«é€£ç·šå­—ä¸²

åœ¨ `appsettings.json` æª”æ¡ˆä¸­å®šç¾©è³‡æ–™åº«é€£ç·šå­—ä¸²ã€‚é€™ä½¿å¾—é€£ç·šè³‡è¨Šèˆ‡ç¨‹å¼ç¢¼åˆ†é›¢ï¼Œæ˜“æ–¼ç®¡ç†å’Œä¿®æ”¹ã€‚

```json
// appsettings.json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    // DefaultConnection æ˜¯å¸¸ç”¨çš„é€£ç·šå­—ä¸²åç¨±
    // æ³¨æ„ï¼šåœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œé€£ç·šå­—ä¸²æ‡‰é€éæ›´å®‰å…¨çš„æ–¹å¼ç®¡ç†ï¼Œä¾‹å¦‚ç’°å¢ƒè®Šæ•¸æˆ– Azure Key Vault
    "DefaultConnection": "Server=(localdb)\\mssqllocaldb;Database=EmployeeDB;Trusted_Connection=True;MultipleActiveResultSets=true"
    // æˆ–è€…ä½¿ç”¨ SQL Server èº«ä»½é©—è­‰:
    // "DefaultConnection": "Server=my-sql-server.database.windows.net;Database=EmployeeDB;User ID=myuser;Password=mypassword;"
  }
}
```

### 5. è¨»å†Š DbContext è‡³ DI å®¹å™¨

åœ¨ `Program.cs` æª”æ¡ˆä¸­ï¼Œå°‡ `ApplicationDbContext` è¨»å†Šåˆ° ASP.NET Core çš„ä¾è³´æ³¨å…¥å®¹å™¨ä¸­ã€‚EF Core å»ºè­°å°‡ `DbContext` è¨»å†Šç‚º **Scoped** ç”Ÿå‘½å‘¨æœŸæœå‹™ï¼Œç¢ºä¿æ¯å€‹ HTTP è«‹æ±‚éƒ½æœ‰ä¸€å€‹ç¨ç«‹çš„ `DbContext` å¯¦ä¾‹ã€‚

```csharp
// Program.cs
using Microsoft.EntityFrameworkCore;
// using YourAppName.Data; // å‡è¨­ ApplicationDbContext å®šç¾©åœ¨é€™å€‹å‘½åç©ºé–“

var builder = WebApplication.CreateBuilder(args);

// å°‡ DbContext è¨»å†Šç‚º Scoped æœå‹™
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

// å…¶ä»–æœå‹™è¨»å†Š...
builder.Services.AddControllersWithViews();

var app = builder.Build();

// ... å…¶ä»–ä¸­é–“ä»¶é…ç½® ...

app.Run();
```
ä¸€æ—¦è¨»å†Šå®Œæˆï¼Œ`ApplicationDbContext` å°±å¯ä»¥é€é**å»ºæ§‹å‡½å¼æ³¨å…¥**åˆ° Controller æˆ–å…¶ä»–æœå‹™ä¸­ã€‚

### 6. å»ºç«‹èˆ‡æ›´æ–°è³‡æ–™åº«ï¼ˆMigrationï¼‰

**è³‡æ–™åº«é·ç§» (Migrations)** æ˜¯ EF Core çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œå®ƒå…è¨±æ ¹æ“š C# è³‡æ–™æ¨¡å‹ï¼ˆModelï¼‰çš„è®ŠåŒ–ä¾†å»ºç«‹å’Œæ›´æ–°è³‡æ–™åº«çµæ§‹ï¼Œè€Œç„¡éœ€æ‰‹å‹•ç·¨å¯« SQLã€‚

- **æ–°å¢ç¬¬ä¸€æ¬¡ Migration (InitialCreate)**ï¼š æ‰“é–‹ **Package Manager Console** (PM>Console) æˆ–å‘½ä»¤æç¤ºå­—å…ƒ (CLI) ä¸¦åˆ‡æ›åˆ°å°ˆæ¡ˆç›®éŒ„ã€‚

```PowerShell
# Visual Studio Package Manager Console
Add-Migration InitialCreate

# .NET CLI (å¦‚æœæœ‰å¤šå€‹å°ˆæ¡ˆï¼Œå¯èƒ½éœ€è¦æŒ‡å®š --project å’Œ --startup-project)
dotnet ef migrations add InitialCreate
```

- é€™å€‹å‘½ä»¤æœƒæ ¹æ“š `ApplicationDbContext` ä¸­çš„ `DbSet` å’Œ Model å®šç¾©ï¼Œåœ¨ `Migrations` è³‡æ–™å¤¾ä¸­ç”Ÿæˆä¸€å€‹ C# æª”æ¡ˆï¼Œè£¡é¢åŒ…å«äº†å»ºç«‹è³‡æ–™åº«è¡¨æ‰€éœ€çš„ SQL ç¨‹å¼ç¢¼ã€‚

- **æ›´æ–°è³‡æ–™åº«**ï¼š å°‡ä¸Šè¿°ç”Ÿæˆçš„ Migration æ‡‰ç”¨åˆ°å¯¦éš›çš„è³‡æ–™åº«ä¸­ã€‚
```PowerShell
# Visual Studio Package Manager Console
Update-Database

# .NET CLI
	dotnet ef database update
```

- é€™å€‹å‘½ä»¤æœƒåŸ·è¡Œæœªæ‡‰ç”¨çš„ Migration è…³æœ¬ï¼Œå¾è€Œå»ºç«‹æˆ–æ›´æ–°è³‡æ–™åº«çµæ§‹ã€‚

- **å¾ŒçºŒ Model è®Šæ›´**ï¼š ç•¶ä½ ä¿®æ”¹äº† Model é¡åˆ¥ï¼ˆä¾‹å¦‚æ·»åŠ æ–°å±¬æ€§ã€ä¿®æ”¹å±¬æ€§é¡å‹ã€å»ºç«‹æ–° Modelï¼‰ï¼Œåªéœ€é‡è¤‡ `Add-Migration` å’Œ `Update-Database` æ­¥é©Ÿï¼š
```PowerShell
Add-Migration AddEmployeeEmailField
Update-Database
```

- **ç”¢ç”Ÿ SQL è…³æœ¬ (ä¾› DBA åŸ·è¡Œ)**ï¼š
```PowerShell
dotnet ef migrations script --output MyScript.sql
```

- é€™æœƒç”Ÿæˆä¸€å€‹ SQL è…³æœ¬ï¼ŒåŒ…å«äº†å¾ä¸Šä¸€å€‹ Migration åˆ°æœ€æ–° Migration çš„æ‰€æœ‰è³‡æ–™åº«è®Šæ›´ï¼Œæ–¹ä¾¿ DBA æˆ–éƒ¨ç½²ç®¡é“åŸ·è¡Œã€‚

### 7. CRUD æ“ä½œç¯„ä¾‹

ä¸€æ—¦ `DbContext` è¨»å†Šä¸¦è³‡æ–™åº«å»ºç«‹å®Œæˆï¼Œå°±å¯ä»¥åœ¨ Controller æˆ–æœå‹™å±¤ä¸­æ³¨å…¥ `ApplicationDbContext` ä¾†åŸ·è¡Œè³‡æ–™åº«çš„ CRUD (Create, Read, Update, Delete) æ“ä½œã€‚

```csharp
// Controllers/EmployeeController.cs
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore; // å¼•å…¥ LINQ to Entities æ“´å……æ–¹æ³•
// using YourAppName.Data; // å‡è¨­ ApplicationDbContext çš„å‘½åç©ºé–“
// using YourAppName.Models; // å‡è¨­ Employee Model çš„å‘½åç©ºé–“

public class EmployeeController : Controller
{
    private readonly ApplicationDbContext _context; // æ³¨å…¥ DbContext

    public EmployeeController(ApplicationDbContext context)
    {
        _context = context;
    }

    // READ (æŸ¥è©¢æ‰€æœ‰å“¡å·¥)
    // GET: /Employee
    public async Task<IActionResult> Index()
    {
        // ToListAsync() æ˜¯éåŒæ­¥æ“ä½œï¼Œæ¨è–¦ç”¨æ–¼ IO-bound å·¥ä½œ
        // AsNoTracking() ç”¨æ–¼åªè®€æŸ¥è©¢ï¼Œå¯ä»¥æå‡æ•ˆèƒ½ï¼Œå› ç‚º EF Core ä¸æœƒè¿½è¹¤é€™äº›å¯¦é«”çš„ç‹€æ…‹è®ŠåŒ–
        var employees = await _context.Employees.AsNoTracking().ToListAsync();
        return View(employees);
    }

    // READ (æŸ¥è©¢å–®ä¸€å“¡å·¥)
    // GET: /Employee/Details/1
    public async Task<IActionResult> Details(int? id)
    {
        if (id == null)
        {
            return NotFound();
        }
        var employee = await _context.Employees.AsNoTracking().FirstOrDefaultAsync(e => e.Id == id);
        if (employee == null)
        {
            return NotFound();
        }
        return View(employee);
    }

    // CREATE (æ–°å¢å“¡å·¥)
    // GET: /Employee/Create (é¡¯ç¤ºè¡¨å–®)
    public IActionResult Create()
    {
        return View();
    }

    // POST: /Employee/Create (è™•ç†è¡¨å–®æäº¤)
    [HttpPost]
    [ValidateAntiForgeryToken]
    public async Task<IActionResult> Create([Bind("Name,Designation")] Employee employee) // ä½¿ç”¨ Bind å±¬æ€§é˜²ç¯„éåº¦ç¶å®š
    {
        if (ModelState.IsValid)
        {
            _context.Add(employee); // å°‡ Employee åŠ å…¥ DbSet çš„è¿½è¹¤
            await _context.SaveChangesAsync(); // å°‡è¿½è¹¤åˆ°çš„è®Šæ›´æŒä¹…åŒ–åˆ°è³‡æ–™åº« (éåŒæ­¥)
            TempData["SuccessMessage"] = "å“¡å·¥æ–°å¢æˆåŠŸï¼";
            return RedirectToAction(nameof(Index));
        }
        return View(employee);
    }

    // UPDATE (æ›´æ–°å“¡å·¥)
    // GET: /Employee/Edit/1 (é¡¯ç¤ºç·¨è¼¯è¡¨å–®)
    public async Task<IActionResult> Edit(int? id)
    {
        if (id == null) return NotFound();
        var employee = await _context.Employees.FindAsync(id); // FindAsync é©ç”¨æ–¼ä¸»éµæŸ¥è©¢
        if (employee == null) return NotFound();
        return View(employee);
    }

    // POST: /Employee/Edit/1 (è™•ç†ç·¨è¼¯è¡¨å–®æäº¤)
    [HttpPost]
    [ValidateAntiForgeryToken]
    public async Task<IActionResult> Edit(int id, [Bind("Id,Name,Designation")] Employee employee)
    {
        if (id != employee.Id) return NotFound();

        if (ModelState.IsValid)
        {
            try
            {
                _context.Update(employee); // å°‡ Employee æ¨™è¨˜ç‚ºå·²ä¿®æ”¹
                await _context.SaveChangesAsync(); // æŒä¹…åŒ–è®Šæ›´
                TempData["SuccessMessage"] = "å“¡å·¥è³‡æ–™æ›´æ–°æˆåŠŸï¼";
            }
            catch (DbUpdateConcurrencyException) // è™•ç†ä¸¦è¡Œè¡çª
            {
                if (!_context.Employees.Any(e => e.Id == employee.Id))
                {
                    return NotFound();
                }
                else
                {
                    throw;
                }
            }
            return RedirectToAction(nameof(Index));
        }
        return View(employee);
    }

    // DELETE (åˆªé™¤å“¡å·¥)
    // POST: /Employee/Delete/1 (é€šå¸¸æ˜¯ POST è«‹æ±‚ä¾†åŸ·è¡Œåˆªé™¤)
    [HttpPost, ActionName("Delete")] // å…è¨±ä½¿ç”¨ /Employee/Delete/1 (POST)
    [ValidateAntiForgeryToken]
    public async Task<IActionResult> DeleteConfirmed(int id)
    {
        var employee = await _context.Employees.FindAsync(id);
        if (employee != null)
        {
            _context.Employees.Remove(employee); // å°‡ Employee æ¨™è¨˜ç‚ºå·²åˆªé™¤
            await _context.SaveChangesAsync(); // æŒä¹…åŒ–è®Šæ›´
            TempData["SuccessMessage"] = "å“¡å·¥è³‡æ–™å·²åˆªé™¤ã€‚";
        }
        return RedirectToAction(nameof(Index));
    }
}
```

- **éåŒæ­¥æ“ä½œ (Async/Await)**ï¼šåœ¨ ASP.NET Core ä¸­ï¼Œå°æ–¼ä»»ä½• I/O å¯†é›†å‹æ“ä½œï¼ˆå¦‚è³‡æ–™åº«å­˜å–ï¼‰ï¼Œå¼·çƒˆå»ºè­°ä½¿ç”¨éåŒæ­¥æ–¹æ³• (`ToListAsync()`, `FirstOrDefaultAsync()`, `SaveChangesAsync()` ç­‰) é…åˆ `async/await` é—œéµå­—ã€‚é€™å¯ä»¥æé«˜æ‡‰ç”¨ç¨‹å¼çš„æ“´å±•æ€§ï¼Œé¿å…é˜»å¡åŸ·è¡Œç·’ã€‚

- **`AsNoTracking()`**ï¼šå°æ–¼åªè®€æŸ¥è©¢ï¼Œä½¿ç”¨ `AsNoTracking()` å¯ä»¥æå‡æ•ˆèƒ½ï¼Œå› ç‚º EF Core ä¸æœƒè¿½è¹¤é€™äº›å¯¦é«”çš„ç‹€æ…‹è®ŠåŒ–ã€‚

- **`DbUpdateConcurrencyException`**ï¼šåœ¨æ›´æ–°æˆ–åˆªé™¤æ™‚ï¼Œå¯èƒ½æœƒç™¼ç”Ÿä¸¦è¡Œè¡çªï¼ˆå³å¤šå€‹ä½¿ç”¨è€…åŒæ™‚ä¿®æ”¹åŒä¸€ç­†è³‡æ–™ï¼‰ã€‚EF Core æä¾›äº†è™•ç†é€™ç¨®æƒ…æ³çš„æ©Ÿåˆ¶ï¼Œé€šå¸¸æ¶‰åŠæ•ç² `DbUpdateConcurrencyException`ã€‚

---
## ğŸ—ï¸ å°ˆæ¡ˆçµæ§‹èˆ‡åˆ†å±¤å»ºè­°

ç‚ºäº†å»ºç«‹å¯ç¶­è­·ã€å¯æ“´å±•ä¸”å¯æ¸¬è©¦çš„æ‡‰ç”¨ç¨‹å¼ï¼Œå»ºè­°æ¡ç”¨åˆ†å±¤æ¶æ§‹ä¸¦å°‡è³‡æ–™å­˜å–é‚è¼¯èˆ‡æ¥­å‹™é‚è¼¯åˆ†é›¢ã€‚

- **è³‡æ–™å­˜å–å±¤ (Data Access Layer - DAL)**ï¼š
	
    - åŒ…å« `DbContext` é¡åˆ¥å’Œæ‰€æœ‰ `DbSet` å®šç¾©ã€‚
	
    - å¯ä»¥å¯¦ä½œ **Repository Pattern (å€‰å„²æ¨¡å¼)**ï¼šç‚ºæ¯å€‹ä¸»è¦å¯¦é«”å»ºç«‹ä¸€å€‹ç¨ç«‹çš„ Repository é¡åˆ¥ï¼ˆä¾‹å¦‚ `EmployeeRepository`ï¼‰ï¼Œå°è£å…¶ CRUD æ“ä½œã€‚é€™ä½¿å¾—æ¥­å‹™é‚è¼¯å±¤ä¸éœ€è¦ç›´æ¥èˆ‡ `DbContext` äº’å‹•ï¼Œé€²ä¸€æ­¥è§£è€¦ã€‚
	
    - å¯ä»¥å¯¦ä½œ **Unit of Work Pattern (å·¥ä½œå–®å…ƒæ¨¡å¼)**ï¼šå°‡å¤šå€‹ Repository å¯¦ä¾‹åŒ…è£åœ¨ä¸€å€‹å·¥ä½œå–®å…ƒä¸­ï¼Œç¢ºä¿å®ƒå€‘å…±ç”¨åŒä¸€å€‹ `DbContext` å¯¦ä¾‹ï¼Œå¾è€Œä¿è­‰äº‹å‹™çš„ä¸€è‡´æ€§ã€‚

- **æ¥­å‹™é‚è¼¯å±¤ (Business Logic Layer - BLL) / æœå‹™å±¤ (Service Layer)**ï¼š
	
    - åŒ…å«æ‡‰ç”¨ç¨‹å¼çš„æ ¸å¿ƒæ¥­å‹™è¦å‰‡å’Œæµç¨‹ã€‚
	
    - é€šå¸¸æœƒæ³¨å…¥ Repository æˆ– `DbContext` ä¾†åŸ·è¡Œè³‡æ–™æ“ä½œã€‚
	
    - ä¾‹å¦‚ï¼Œä¸€å€‹ `ProductService` å¯èƒ½æœƒä½¿ç”¨ `IProductRepository` ä¾†ç²å–ç”¢å“ï¼Œç„¶å¾Œæ‡‰ç”¨æŠ˜æ‰£é‚è¼¯æˆ–åŸ·è¡Œè¤‡é›œçš„é©—è­‰ã€‚

- **è¡¨ç¤ºå±¤ (Presentation Layer)**ï¼š
    
    - å³ Controller å’Œ Viewï¼Œè² è²¬è™•ç† HTTP è«‹æ±‚å’Œå‘ˆç¾ä½¿ç”¨è€…ä»‹é¢ã€‚
	
    - Controller æ‡‰ç›¡é‡ä¿æŒè¼•é‡ï¼Œä¸»è¦è² è²¬æ¥æ”¶è«‹æ±‚ã€èª¿ç”¨æœå‹™å±¤çš„æ¥­å‹™é‚è¼¯ï¼Œç„¶å¾Œå°‡çµæœå‚³éçµ¦ Viewã€‚

é€™ç¨®åˆ†å±¤æ¶æ§‹çµåˆä¾è³´æ³¨å…¥ï¼Œæ¥µå¤§åœ°æå‡äº†ç¨‹å¼ç¢¼çš„**å¯æ¸¬è©¦æ€§**ã€**å¯ç¶­è­·æ€§**å’Œ**å¯æ“´å±•æ€§**ã€‚

---
## ## âš ï¸ å¸¸è¦‹å•é¡Œèˆ‡æ’æŸ¥

- **Migration å¤±æ•—æˆ–éŒ¯èª¤**ï¼š
    
    - æª¢æŸ¥ `appsettings.json` ä¸­çš„**é€£ç·šå­—ä¸²**æ˜¯å¦æ­£ç¢ºï¼Œå°¤å…¶æ˜¯ä¼ºæœå™¨åç¨±ã€è³‡æ–™åº«åç¨±å’Œèªè­‰è³‡è¨Šã€‚
        
    - ç¢ºèªåŸ·è¡Œ Migration çš„ä½¿ç”¨è€…å¸³æˆ¶å…·æœ‰è¶³å¤ çš„**è³‡æ–™åº«æ¬Šé™**ï¼ˆä¾‹å¦‚å»ºç«‹è³‡æ–™åº«å’Œè¡¨çš„æ¬Šé™ï¼‰ã€‚
        
    - å¦‚æœéŒ¯èª¤è¨Šæ¯ä¸æ˜ç¢ºï¼Œå˜—è©¦é‹è¡Œ `dotnet ef migrations script -o debug.sql` ä¾†æŸ¥çœ‹ EF Core å˜—è©¦åŸ·è¡Œçš„ SQL è…³æœ¬ï¼Œé€™é€šå¸¸èƒ½æä¾›æ›´å¤šç·šç´¢ã€‚
        
    - æª¢æŸ¥æ¨¡å‹å®šç¾©æ˜¯å¦æœ‰æ½›åœ¨å•é¡Œï¼Œä¾‹å¦‚æœªå®šç¾©ä¸»éµï¼ˆå¦‚æœ EF Core ç„¡æ³•æ¨æ–·ï¼‰ã€‚
        
- **`DbContext` æœªè¨»å†Šæˆ–æ³¨å…¥éŒ¯èª¤**ï¼š
    
    - ç¢ºä¿åœ¨ `Program.cs` ä¸­æ­£ç¢ºä½¿ç”¨äº† `builder.Services.AddDbContext<ApplicationDbContext>(...)`ã€‚
        
    - ç¢ºèª Controller æˆ–æœå‹™çš„å»ºæ§‹å‡½å¼ä¸­ï¼Œåƒæ•¸å‹åˆ¥èˆ‡è¨»å†Šçš„æœå‹™å‹åˆ¥ä¸€è‡´ã€‚
        
- **è³‡æ–™æ¨¡å‹è®Šæ›´æœªåŒæ­¥åˆ°è³‡æ–™åº«**ï¼š
    
    - åœ¨ä¿®æ”¹ Model å¾Œï¼Œå‹™å¿…åŸ·è¡Œ `Add-Migration <MigrationName>` å’Œ `Update-Database` å‘½ä»¤ã€‚
    
    - å¦‚æœå·²ç¶“éƒ¨ç½²ï¼Œéœ€è¦ç¢ºä¿åœ¨éƒ¨ç½²éç¨‹ä¸­åŸ·è¡Œ `Update-Database`ï¼Œæˆ–è€…æ‰‹å‹•æ‡‰ç”¨ Migration è…³æœ¬ã€‚
    
- **æ•ˆèƒ½å•é¡Œ (N+1 æŸ¥è©¢å•é¡Œ)**ï¼š

    - ç•¶æŸ¥è©¢åŒ…å«å°è¦½å±¬æ€§ï¼ˆä¾‹å¦‚æŸ¥è©¢å“¡å·¥åŠå…¶æ‰€æœ‰è¨‚å–®ï¼‰æ™‚ï¼Œå¦‚æœæ²’æœ‰é©ç•¶è™•ç†ï¼ŒEF Core å¯èƒ½æœƒç‚ºæ¯å€‹å“¡å·¥å–®ç¨ç™¼é€ä¸€å€‹æŸ¥è©¢å»ç²å–å…¶è¨‚å–®ï¼Œå°è‡´ N+1 æŸ¥è©¢å•é¡Œã€‚
    
    - **è§£æ±ºæ–¹æ¡ˆ**ï¼š
        - ä½¿ç”¨ `Include()` æˆ– `ThenInclude()` ä¾†**é å…ˆè¼‰å…¥ (Eager Loading)** ç›¸é—œè³‡æ–™ã€‚
        ```csharp
        var employeesWithOrders = await _context.Employees.Include(e => e.Orders).ToListAsync();
		```
		- å°æ–¼åªè®€ä¸”ä¸éœ€è¿½è¹¤çš„è³‡æ–™ï¼Œä½¿ç”¨ `AsNoTracking()`ã€‚
	
        - é‡å°è¤‡é›œæŸ¥è©¢æˆ–å¤§æ•¸æ“šé‡ï¼Œè€ƒæ…®ä½¿ç”¨ `Select()` ä¾†åªé¸æ“‡å¿…è¦çš„æ¬„ä½ï¼Œé¿å…è¼‰å…¥æ•´å€‹å¯¦é«”ã€‚

- **ä¸¦è¡Œè¡çª (Concurrency Conflicts)**ï¼š
    - å¤šå€‹ä½¿ç”¨è€…åŒæ™‚ä¿®æ”¹åŒä¸€ç­†è³‡æ–™æ™‚ï¼Œå¾Œä¸€å€‹å„²å­˜çš„æ“ä½œå¯èƒ½æœƒè¦†è“‹å‰ä¸€å€‹ã€‚
    
    - **è§£æ±ºæ–¹æ¡ˆ**ï¼šåœ¨ Model ä¸­æ·»åŠ  `[ConcurrencyCheck]` å±¬æ€§æˆ–ä½¿ç”¨ `byte[] RowVersion` å±¬æ€§é…åˆ `[Timestamp]` è¨»è§£ã€‚EF Core æœƒåœ¨æ›´æ–°æ™‚æª¢æŸ¥æ­¤æ¬„ä½ï¼Œå¦‚æœç™¼ç¾è¡çªå‰‡æ‹‹å‡º `DbUpdateConcurrencyException`ã€‚

---
## ğŸ” å»¶ä¼¸å­¸ç¿’è³‡æº

- **[Microsoft Learnï¼šEF Core æ¦‚è§€](https://learn.microsoft.com/zh-tw/ef/core/)**
- [**Microsoft Learnï¼šEF Core Migration æŒ‡å—**](https://learn.microsoft.com/zh-tw/ef/core/managing-schemas/migrations/?tabs=dotnet-core-cli)
- [**ASP.NET Core MVC èˆ‡ EF Core å¯¦ä½œæ•™å­¸**](https://learn.microsoft.com/zh-tw/aspnet/core/data/ef-mvc/?view=aspnetcore-9.0)
- [**Entity Framework Core GitHub ç¯„ä¾‹**](https://github.com/dotnet/efcore)

---
## ğŸ”— ç›¸é—œå¡ç‰‡

- [[011.6-CoreMVC-ä¾è³´æ³¨å…¥èˆ‡æœå‹™è¨»å†Š]]
- [[011.8-CoreMVC-åˆ†å±¤æ¶æ§‹èˆ‡å°ˆæ¡ˆå¯¦å‹™è¨­è¨ˆ]]
- [[007-LINQ-ç¸½è¦½]]
