---
title: ğŸ”’ 011.13-CoreMVC-å®‰å…¨æ€§èˆ‡æˆæ¬Š (Authentication & Authorization)
tags:
- ASP-NET
- Core
- å®‰å…¨æ€§
- Authentication
- Authorization
- èº«ä»½é©—è­‰
- æˆæ¬Š
- Identity
- JWT
- Cookie
- OAuth
- Role-based
- Policy-based
aliases:
- CoreMVC å®‰å…¨æ€§
- ASP.NET Core é©—è­‰æˆæ¬Š
created: 2025-07-10
updated: 2025-07-10
status: è‰ç¨¿
summary: æœ¬ç­†è¨˜æ·±å…¥æ¢è¨ ASP.NET Core MVC ä¸­çš„èº«ä»½é©—è­‰ (Authentication) èˆ‡æˆæ¬Š (Authorization) æ©Ÿåˆ¶ã€‚å…§å®¹æ¶µè“‹å…©è€…çš„æ ¸å¿ƒæ¦‚å¿µã€ä¸åŒé©—è­‰æ–¹æ¡ˆï¼ˆCookie, JWT, OAuth/OpenID Connectï¼‰ã€ASP.NET Core Identity çš„æ‡‰ç”¨ã€åŸºæ–¼è§’è‰²èˆ‡åŸºæ–¼ç­–ç•¥çš„æˆæ¬Šå¯¦ç¾ï¼Œä»¥åŠå¸¸è¦‹çš„å®‰å…¨è­°é¡Œï¼Œå”åŠ©é–‹ç™¼è€…å»ºæ§‹å®‰å…¨å¯é çš„ Web æ‡‰ç”¨ç¨‹å¼ã€‚
---

åœ¨ä»»ä½• Web æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œ**å®‰å…¨æ€§ (Security)** éƒ½æ˜¯é‡ä¸­ä¹‹é‡ã€‚å®ƒç¢ºä¿åªæœ‰åˆæ³•çš„ç”¨æˆ¶æ‰èƒ½è¨ªå•å…¶æ‡‰æœ‰çš„è³‡æºï¼Œä¸¦ä¿è­·æ•¸æ“šå…å—æœªç¶“æˆæ¬Šçš„è¨ªå•å’Œç¯¡æ”¹ã€‚ASP.NET Core æä¾›äº†ä¸€å€‹å¼·å¤§ä¸”éˆæ´»çš„å®‰å…¨æ€§æ¡†æ¶ï¼Œå…¶æ ¸å¿ƒåœç¹è‘—å…©å€‹ä¸»è¦æ¦‚å¿µï¼š**èº«ä»½é©—è­‰ (Authentication)** å’Œ **æˆæ¬Š (Authorization)**ã€‚

---
## ğŸ“ æ ¸å¿ƒæ¦‚å¿µï¼šé©—è­‰èˆ‡æˆæ¬Š

åœ¨è¨è«–å…·é«”å¯¦ç¾ä¹‹å‰ï¼Œè®“æˆ‘å€‘å…ˆé‡æ¸…é€™å…©å€‹ç¶“å¸¸æ··æ·†ä½†æœ¬è³ªä¸åŒçš„æ¦‚å¿µï¼š

- **èº«ä»½é©—è­‰ (Authentication)**ï¼š
    
    - **è§£æ±ºçš„å•é¡Œ**ï¼šã€Œä½ æ˜¯èª°ï¼Ÿã€
    
    - **å®šç¾©**ï¼šé©—è­‰ç”¨æˆ¶çš„èº«ä»½ã€‚å®ƒæ˜¯æ ¸å¯¦ç”¨æˆ¶è²ç¨±çš„èº«ä»½æ˜¯å¦çœŸå¯¦çš„éç¨‹ã€‚
    
    - **å¸¸ç”¨æ–¹å¼**ï¼šç”¨æˆ¶å/å¯†ç¢¼ã€ç¬¬ä¸‰æ–¹ç™»å…¥ (Google, Facebook)ã€æŒ‡ç´‹ã€OTP (ä¸€æ¬¡æ€§å¯†ç¢¼)ã€é›»å­æ†‘è­‰ç­‰ã€‚
    
    - **çµæœ**ï¼šå¦‚æœé©—è­‰æˆåŠŸï¼Œç³»çµ±æœƒçŸ¥é“ç•¶å‰è«‹æ±‚æ˜¯ç”±å“ªå€‹**å·²é©—è­‰ä¸»é«” (Authenticated Principal)** ç™¼å‡ºçš„ã€‚é€™å€‹ä¸»é«”é€šå¸¸ç”± `ClaimsPrincipal` ç‰©ä»¶è¡¨ç¤ºï¼ŒåŒ…å«ä¸€å€‹æˆ–å¤šå€‹èº«ä»½ (Identity) å’Œä¸€ç³»åˆ—è²æ˜ (Claims)ã€‚

- **æˆæ¬Š (Authorization)**ï¼š
    
    - **è§£æ±ºçš„å•é¡Œ**ï¼šã€Œä½ è¢«å…è¨±åšä»€éº¼ï¼Ÿã€
    
    - **å®šç¾©**ï¼šåœ¨ç”¨æˆ¶èº«ä»½è¢«é©—è­‰ä¹‹å¾Œï¼Œæ±ºå®šè©²ç”¨æˆ¶æ˜¯å¦æœ‰æ¬Šé™åŸ·è¡ŒæŸå€‹æ“ä½œæˆ–è¨ªå•æŸå€‹è³‡æºã€‚
    
    - **å¸¸ç”¨æ–¹å¼**ï¼šåŸºæ–¼è§’è‰² (Role-based)ã€åŸºæ–¼ç­–ç•¥ (Policy-based)ã€åŸºæ–¼è²æ˜ (Claims-based)ã€‚
    
    - **çµæœ**ï¼šæ±ºå®šç”¨æˆ¶æ˜¯å…è¨±è¨ªå• (Granted) é‚„æ˜¯æ‹’çµ•è¨ªå• (Denied)ã€‚

**ç°¡è€Œè¨€ä¹‹ï¼šé©—è­‰æ˜¯ã€Œç™»å…¥ã€ï¼Œæˆæ¬Šæ˜¯ã€Œæ¬Šé™ã€ã€‚**

---
## ğŸ› ï¸ ASP.NET Core ä¸­çš„èº«ä»½é©—è­‰ (Authentication)

ASP.NET Core çš„èº«ä»½é©—è­‰ç³»çµ±æ˜¯åŸºæ–¼**é©—è­‰æ–¹æ¡ˆ (Authentication Schemes)** çš„ã€‚ä¸€å€‹é©—è­‰æ–¹æ¡ˆç”±ä¸€å€‹è™•ç†ç¨‹åº (Handler) å’Œä¸€çµ„è¨­å®š (Options) çµ„æˆï¼Œå®ƒå®šç¾©äº†å¦‚ä½•é©—è­‰ç”¨æˆ¶ä»¥åŠå¦‚ä½•è™•ç†é©—è­‰çµæœã€‚

å¸¸è¦‹çš„é©—è­‰æ–¹æ¡ˆé¡å‹ï¼š

### 1. Cookie é©—è­‰ (Cookie Authentication)

- **æ©Ÿåˆ¶**ï¼šç•¶ç”¨æˆ¶æˆåŠŸç™»å…¥å¾Œï¼Œä¼ºæœå™¨æœƒç”Ÿæˆä¸€å€‹åŠ å¯†çš„ Cookie ä¸¦ç™¼é€çµ¦ç€è¦½å™¨ã€‚ç€è¦½å™¨åœ¨å¾ŒçºŒçš„æ¯æ¬¡è«‹æ±‚ä¸­éƒ½æœƒè‡ªå‹•æ”œå¸¶é€™å€‹ Cookieï¼Œä¼ºæœå™¨é€šéé©—è­‰ Cookie ä¾†è­˜åˆ¥ç”¨æˆ¶ã€‚

- **é©ç”¨å ´æ™¯**ï¼šå‚³çµ±çš„ Web æ‡‰ç”¨ç¨‹å¼ï¼ˆMVC æ‡‰ç”¨ç¨‹å¼ï¼‰ï¼Œç”¨æˆ¶åœ¨ç€è¦½å™¨ä¸­æ“ä½œã€‚

- **å„ªé»**ï¼š
    - ç°¡å–®æ˜“ç”¨ï¼Œç”±ç€è¦½å™¨è‡ªå‹•è™•ç†ã€‚
    
    - å…§å»ºé˜² CSRF ä¿è­·ã€‚

- **ç¼ºé»**ï¼š
    - ä¸é©ç”¨æ–¼ API æ‡‰ç”¨ç¨‹å¼æˆ–ç§»å‹•æ‡‰ç”¨ç¨‹å¼ (å®ƒå€‘é€šå¸¸ä¸ä¾è³´ç€è¦½å™¨ Cookie)ã€‚
    
    - è·¨åŸŸ (CORS) è¤‡é›œæ€§ã€‚


#### é…ç½® Cookie é©—è­‰

1. **åœ¨ `Program.cs` ä¸­è¨»å†Šæœå‹™**ï¼š
```csharp
// Program.cs
var builder = WebApplication.CreateBuilder(args);

builder.Services.AddControllersWithViews();

// é…ç½® Cookie é©—è­‰
builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie(options =>
    {
        options.LoginPath = "/Account/Login"; // æœªæˆæ¬Šæ™‚é‡å®šå‘çš„ç™»å…¥é é¢
        options.LogoutPath = "/Account/Logout"; // ç™»å‡ºè·¯å¾‘
        options.AccessDeniedPath = "/Account/AccessDenied"; // æ‹’çµ•è¨ªå•æ™‚çš„é é¢
        options.ExpireTimeSpan = TimeSpan.FromMinutes(30); // Cookie éæœŸæ™‚é–“
        options.SlidingExpiration = true; // æ»‘å‹•éæœŸ (æ¯æ¬¡è«‹æ±‚éƒ½æœƒé‡è¨­éæœŸæ™‚é–“)
        options.Cookie.HttpOnly = true; // è¨­ç½® HttpOnly ä»¥é˜²æ­¢ XSS æ”»æ“Š
        options.Cookie.IsEssential = true; // æ¨™è¨˜ç‚ºåŸºæœ¬ Cookieï¼Œä»¥ç¬¦åˆ GDPR è¦æ±‚
    });

// ... å…¶ä»–æœå‹™è¨»å†Š ...

var app = builder.Build();

// ç¢ºä¿ UseAuthentication åœ¨ UseAuthorization ä¹‹å‰
app.UseAuthentication(); // å•Ÿç”¨èº«ä»½é©—è­‰ä¸­ä»‹è»Ÿé«”
app.UseAuthorization();  // å•Ÿç”¨æˆæ¬Šä¸­ä»‹è»Ÿé«”

// ...
```

2. **ç™»å…¥é‚è¼¯ (Controller)**ï¼š

```csharp
// Controllers/AccountController.cs
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.AspNetCore.Mvc;
using System.Security.Claims; // å¼•å…¥å‘½åç©ºé–“

public class AccountController : Controller
{
    [HttpGet]
    public IActionResult Login(string returnUrl = null)
    {
        ViewData["ReturnUrl"] = returnUrl;
        return View();
    }

    [HttpPost]
    [ValidateAntiForgeryToken] // å•Ÿç”¨ CSRF ä¿è­·
    public async Task<IActionResult> Login(LoginViewModel model, string returnUrl = null)
    {
        ViewData["ReturnUrl"] = returnUrl;
        if (ModelState.IsValid)
        {
            // é€™è£¡æ‡‰è©²é©—è­‰ç”¨æˆ¶åå’Œå¯†ç¢¼ (ä¾‹å¦‚æŸ¥è©¢è³‡æ–™åº«)
            if (model.Username == "test" && model.Password == "password")
            {
                var claims = new List<Claim>
                {
                    new Claim(ClaimTypes.Name, model.Username),
                    new Claim(ClaimTypes.Email, "test@example.com"),
                    new Claim(ClaimTypes.Role, "Admin") // æ·»åŠ è§’è‰²è²æ˜
                };

                var claimsIdentity = new ClaimsIdentity(
                    claims, CookieAuthenticationDefaults.AuthenticationScheme);

                var authProperties = new AuthenticationProperties
                {
                    IsPersistent = model.RememberMe, // è¨˜ä½æˆ‘ (æŒä¹…åŒ– Cookie)
                    ExpiresUtc = model.RememberMe ? DateTimeOffset.UtcNow.AddDays(7) : (DateTimeOffset?)null
                };

                await HttpContext.SignInAsync( // åŸ·è¡Œç™»å…¥
                    CookieAuthenticationDefaults.AuthenticationScheme,
                    new ClaimsPrincipal(claimsIdentity),
                    authProperties);

                // é‡æ–°å°å‘åˆ°åŸå§‹è«‹æ±‚çš„ URL æˆ–é è¨­é¦–é 
                return Redirect(returnUrl ?? "/");
            }
            ModelState.AddModelError(string.Empty, "ç„¡æ•ˆçš„ç™»å…¥å˜—è©¦ã€‚");
        }
        return View(model);
    }

    [HttpPost]
    public async Task<IActionResult> Logout()
    {
        await HttpContext.SignOutAsync(CookieAuthenticationDefaults.AuthenticationScheme); // åŸ·è¡Œç™»å‡º
        return RedirectToAction("Index", "Home");
    }

    [HttpGet]
    public IActionResult AccessDenied()
    {
        return View();
    }
}
```

### 2. JWT é©—è­‰ (JSON Web Token Authentication)

- **æ©Ÿåˆ¶**ï¼šç”¨æˆ¶ç™»å…¥å¾Œï¼Œä¼ºæœå™¨ç”Ÿæˆä¸€å€‹åŒ…å«ç”¨æˆ¶è³‡è¨Šï¼ˆè²æ˜ï¼‰çš„ JWT ä¸¦è¿”å›çµ¦å®¢æˆ¶ç«¯ã€‚å®¢æˆ¶ç«¯ï¼ˆä¾‹å¦‚å‰ç«¯æ‡‰ç”¨æˆ–ç§»å‹• Appï¼‰åœ¨å¾ŒçºŒè«‹æ±‚ä¸­å°‡ JWT æ”¾ç½®åœ¨ HTTP Header ä¸­ï¼ˆé€šå¸¸æ˜¯ `Authorization: Bearer <token>`ï¼‰ï¼Œä¼ºæœå™¨é©—è­‰ JWT çš„ç°½åå’Œæœ‰æ•ˆæœŸä¾†è­˜åˆ¥ç”¨æˆ¶ã€‚

- **é©ç”¨å ´æ™¯**ï¼šAPI æ‡‰ç”¨ç¨‹å¼ã€SPA (å–®é æ‡‰ç”¨ç¨‹å¼)ã€è¡Œå‹•æ‡‰ç”¨ç¨‹å¼ã€å¾®æœå‹™ä¹‹é–“çš„é€šè¨Šã€‚

- **å„ªé»**ï¼š
    - ç„¡ç‹€æ…‹ (Stateless)ï¼šä¼ºæœå™¨ä¸éœ€è¦å„²å­˜æœƒè©±ç‹€æ…‹ï¼Œæœ‰åˆ©æ–¼æ“´å±•ã€‚
    
    - è·¨åŸŸå‹å¥½ã€‚
    
    - å¯ç”¨æ–¼åˆ†æ•£å¼ç³»çµ±ã€‚

- **ç¼ºé»**ï¼š
    - ä»¤ç‰Œè¢«ç›œç”¨å¾Œé›£ä»¥æ’¤éŠ· (é™¤éå¯¦ç¾é»‘åå–®æ©Ÿåˆ¶)ã€‚
    
    - ä»¤ç‰Œå¯èƒ½åŒ…å«æ•æ„Ÿæ•¸æ“š (æ‡‰åŠ å¯†æˆ–åªåŒ…å«å¿…è¦æ•¸æ“š)ã€‚

#### é…ç½® JWT é©—è­‰

1. **å®‰è£ NuGet å¥—ä»¶**ï¼š`Microsoft.AspNetCore.Authentication.JwtBearer`

2. **åœ¨ `appsettings.json` ä¸­é…ç½® JWT è¨­å®š**ï¼š
```json
{
  "JwtSettings": {
    "Issuer": "YourIssuer",
    "Audience": "YourAudience",
    "Key": "ThisIsAVerySecretKeyForJWTAuthAndItMustBeLongEnough" // è‡³å°‘ 16 å­—ç¯€ï¼Œç”Ÿç”¢ç’°å¢ƒè«‹ä½¿ç”¨æ›´å®‰å…¨çš„ç®¡ç†æ–¹å¼
  },
  "AllowedHosts": "*"
}
```

3. **åœ¨ `Program.cs` ä¸­è¨»å†Šæœå‹™**ï¼š
```csharp
// Program.cs
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.IdentityModel.Tokens;
using System.Text;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddControllers(); // é€šå¸¸ç”¨æ–¼ API å°ˆæ¡ˆ

// é…ç½® JWT é©—è­‰
builder.Services.AddAuthentication(options =>
{
    options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
    options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
})
.AddJwtBearer(options =>
{
    options.TokenValidationParameters = new TokenValidationParameters
    {
        ValidateIssuer = true, // é©—è­‰ç™¼è¡Œè€…
        ValidateAudience = true, // é©—è­‰å—çœ¾
        ValidateLifetime = true, // é©—è­‰æœ‰æ•ˆæœŸ
        ValidateIssuerSigningKey = true, // é©—è­‰ç°½åé‡‘é‘°
        ValidIssuer = builder.Configuration["JwtSettings:Issuer"],
        ValidAudience = builder.Configuration["JwtSettings:Audience"],
        IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(builder.Configuration["JwtSettings:Key"]))
    };
});

// ... å…¶ä»–æœå‹™è¨»å†Š ...

var app = builder.Build();

// ç¢ºä¿ UseAuthentication åœ¨ UseAuthorization ä¹‹å‰
app.UseAuthentication();
app.UseAuthorization();

// ...
```

4. **ç”Ÿæˆ JWT ä»¤ç‰Œçš„ API (Controller)**ï¼š
```csharp
// Controllers/AuthController.cs
using Microsoft.AspNetCore.Mvc;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using Microsoft.IdentityModel.Tokens;
using System.Text;
using Microsoft.Extensions.Configuration; // æ³¨å…¥ IConfiguration

[ApiController]
[Route("api/[controller]")]
public class AuthController : ControllerBase
{
    private readonly IConfiguration _configuration;

    public AuthController(IConfiguration configuration)
    {
        _configuration = configuration;
    }

    [HttpPost("login")]
    public IActionResult Login([FromBody] LoginViewModel model)
    {
        // é€™è£¡æ‡‰è©²é©—è­‰ç”¨æˆ¶åå’Œå¯†ç¢¼
        if (model.Username == "apiuser" && model.Password == "apipassword")
        {
            var claims = new List<Claim>
            {
                new Claim(ClaimTypes.Name, model.Username),
                new Claim(ClaimTypes.Role, "ApiUser")
            };

            var securityKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_configuration["JwtSettings:Key"]));
            var credentials = new SigningCredentials(securityKey, SecurityAlgorithms.HmacSha256);

            var token = new JwtSecurityToken(
                issuer: _configuration["JwtSettings:Issuer"],
                audience: _configuration["JwtSettings:Audience"],
                claims: claims,
                expires: DateTime.Now.AddMinutes(30), // ä»¤ç‰Œæœ‰æ•ˆæœŸ
                signingCredentials: credentials);

            return Ok(new { Token = new JwtSecurityTokenHandler().WriteToken(token) });
        }
        return Unauthorized("ç„¡æ•ˆçš„ç”¨æˆ¶åæˆ–å¯†ç¢¼ã€‚");
    }
}
```

### 3. ASP.NET Core Identity

- **æ©Ÿåˆ¶**ï¼šä¸€å€‹å®Œæ•´çš„èº«ä»½ç®¡ç†ç³»çµ±ï¼ŒåŒ…å«äº†ç”¨æˆ¶ç®¡ç†ã€å¯†ç¢¼é‡ç½®ã€å…©æ­¥é©Ÿé©—è­‰ã€å¤–éƒ¨ç™»å…¥ (OAuth/OpenID Connect) ç­‰åŠŸèƒ½ã€‚å®ƒåŸºæ–¼ EF Core å„²å­˜ç”¨æˆ¶æ•¸æ“šã€‚

- **é©ç”¨å ´æ™¯**ï¼šéœ€è¦å®Œæ•´ç”¨æˆ¶å¸³æˆ¶ç®¡ç†åŠŸèƒ½çš„ Web æ‡‰ç”¨ç¨‹å¼ã€‚

- **å„ªé»**ï¼š
    - åŠŸèƒ½è±å¯Œï¼Œé–‹ç®±å³ç”¨ã€‚
    
    - é«˜åº¦å¯æ“´å±•å’Œè‡ªå®šç¾©ã€‚
    
    - èˆ‡ Cookie å’Œå¤–éƒ¨ç™»å…¥æ–¹æ¡ˆç„¡ç¸«æ•´åˆã€‚

- **ç¼ºé»**ï¼š
    - å°æ–¼ç°¡å–®çš„ API æ‡‰ç”¨å¯èƒ½éæ–¼è¤‡é›œã€‚

#### é…ç½® ASP.NET Core Identity

1. **å®‰è£ NuGet å¥—ä»¶**ï¼š`Microsoft.AspNetCore.Identity.EntityFrameworkCore`ã€`Microsoft.EntityFrameworkCore.SqlServer` (æˆ–å…¶ä»–è³‡æ–™åº«æä¾›è€…)ã€‚

2. **å®šç¾©ç”¨æˆ¶å’Œè§’è‰²é¡åˆ¥** (é€šå¸¸ç¹¼æ‰¿è‡ª `IdentityUser` å’Œ `IdentityRole`)ã€‚

3. **åœ¨ `Program.cs` ä¸­é…ç½® Identity å’Œè³‡æ–™åº«ä¸Šä¸‹æ–‡**ï¼š
```csharp
// Program.cs
using Microsoft.AspNetCore.Identity;
using Microsoft.EntityFrameworkCore;
// using YourProject.Data; // å¼•å…¥æ‚¨çš„ DbContext å‘½åç©ºé–“
// using YourProject.Models; // å¼•å…¥æ‚¨çš„ ApplicationUser å‘½åç©ºé–“

var builder = WebApplication.CreateBuilder(args);

var connectionString = builder.Configuration.GetConnectionString("DefaultConnection") ?? throw new InvalidOperationException("Connection string 'DefaultConnection' not found.");
builder.Services.AddDbContext<ApplicationDbContext>(options =>
    options.UseSqlServer(connectionString));

builder.Services.AddDatabaseDeveloperPageExceptionFilter();

// é…ç½® Identity
builder.Services.AddDefaultIdentity<ApplicationUser>(options => options.SignIn.RequireConfirmedAccount = true)
    .AddRoles<IdentityRole>() // å¦‚æœéœ€è¦è§’è‰²ç®¡ç†
    .AddEntityFrameworkStores<ApplicationDbContext>();

// ...
```

#### Identity çš„ä½¿ç”¨

- é€éæ³¨å…¥ `UserManager<ApplicationUser>` å’Œ `SignInManager<ApplicationUser>` ä¾†é€²è¡Œç”¨æˆ¶ç®¡ç†å’Œç™»å…¥/ç™»å‡ºæ“ä½œã€‚

- Identity æœƒè‡ªå‹•é…ç½® Cookie é©—è­‰ã€‚

### 4. å¤–éƒ¨èº«ä»½é©—è­‰ (External Authentication) - OAuth/OpenID Connect

- **æ©Ÿåˆ¶**ï¼šå…è¨±ç”¨æˆ¶ä½¿ç”¨ç¬¬ä¸‰æ–¹æœå‹™ï¼ˆå¦‚ Google, Facebook, Microsoft, GitHubï¼‰çš„å¸³æˆ¶ç™»å…¥æ‚¨çš„æ‡‰ç”¨ç¨‹å¼ã€‚é€šå¸¸åŸºæ–¼ OAuth 2.0 å’Œ OpenID Connect å”è­°ã€‚

- **é©ç”¨å ´æ™¯**ï¼šæä¾›æ›´ä¾¿æ·çš„ç™»å…¥æ–¹å¼ï¼Œæ¸›å°‘ç”¨æˆ¶è¨˜æ†¶å¯†ç¢¼çš„è² æ“”ã€‚

- **é…ç½®**ï¼šä½¿ç”¨ `AddGoogle()`, `AddFacebook()`, `AddMicrosoftAccount()` ç­‰æ“´å±•æ–¹æ³•ã€‚

---
## ğŸ”’ ASP.NET Core ä¸­çš„æˆæ¬Š (Authorization)

ä¸€æ—¦ç”¨æˆ¶çš„èº«ä»½è¢«é©—è­‰ï¼Œæˆæ¬Šå±¤æ¬¡å°±æœƒæ±ºå®šä»–å€‘è¢«å…è¨±è¨ªå•å“ªäº›è³‡æºæˆ–åŸ·è¡Œå“ªäº›æ“ä½œã€‚ASP.NET Core æä¾›åŸºæ–¼ä»¥ä¸‹æ–¹å¼çš„æˆæ¬Šï¼š

### 1. åŸºæ–¼è§’è‰²çš„æˆæ¬Š (Role-based Authorization)

- æœ€ç°¡å–®ç›´æ¥çš„æˆæ¬Šæ–¹å¼ã€‚ç”¨æˆ¶è¢«åˆ†é…åˆ°ä¸€å€‹æˆ–å¤šå€‹è§’è‰²ï¼ˆå¦‚ Admin, Editor, Userï¼‰ï¼Œç„¶å¾ŒåŸºæ–¼é€™äº›è§’è‰²ä¾†æˆäºˆæ¬Šé™ã€‚

- **ä½¿ç”¨ `[Authorize(Roles = "RoleName1,RoleName2")]` ç‰¹æ€§ (Attribute)**ï¼š
```csharp
// Controllers/AdminController.cs
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

[Authorize(Roles = "Admin")] // åªæœ‰ Admin è§’è‰²æ‰èƒ½è¨ªå•é€™å€‹æ§åˆ¶å™¨ä¸­çš„æ‰€æœ‰ Action
public class AdminController : Controller
{
    public IActionResult Index()
    {
        return View();
    }

    [Authorize(Roles = "SuperAdmin")] // åªæœ‰ SuperAdmin è§’è‰²æ‰èƒ½è¨ªå•é€™å€‹ Action
    public IActionResult ManageUsers()
    {
        return View();
    }
}

[Authorize] // åªè¦æ˜¯å·²é©—è­‰ç”¨æˆ¶å°±èƒ½è¨ªå•
public class ProductController : Controller
{
    [AllowAnonymous] // å…è¨±æœªé©—è­‰ç”¨æˆ¶è¨ªå• (è¦†è“‹æ§åˆ¶å™¨å±¤ç´šçš„ Authorize)
    public IActionResult PublicProducts()
    {
        return View();
    }
}
```

- **ç¨‹å¼ç¢¼ä¸­çš„æª¢æŸ¥ (è¼ƒä¸æ¨è–¦ï¼Œå„ªå…ˆä½¿ç”¨ç‰¹æ€§)**ï¼š
```csharp
if (User.IsInRole("Admin"))
{
    // åŸ·è¡Œç®¡ç†å“¡æ“ä½œ
}
```

### 2. åŸºæ–¼ç­–ç•¥çš„æˆæ¬Š (Policy-based Authorization)

- æ›´éˆæ´»å’Œå¯æ“´å±•çš„æˆæ¬Šæ–¹å¼ã€‚å®ƒå…è¨±æ‚¨å®šç¾©è¤‡é›œçš„æˆæ¬Šè¦å‰‡ï¼Œé€™äº›è¦å‰‡å¯ä»¥åŸºæ–¼ï¼š
    
    - **è§’è‰² (Roles)**ï¼šå¯ä»¥åŒ…å«å¤šå€‹è§’è‰²ã€‚
    
    - **è²æ˜ (Claims)**ï¼šåŸºæ–¼ç”¨æˆ¶çš„è²æ˜ï¼ˆå¦‚ç”¨æˆ¶å¹´é½¡ã€éƒ¨é–€ã€åœ‹å®¶ç­‰ï¼‰é€²è¡Œæˆæ¬Šã€‚
    
    - **è¦æ±‚è™•ç†å™¨ (Requirement Handlers)**ï¼šè‡ªå®šç¾©è¤‡é›œçš„æ¥­å‹™é‚è¼¯ã€‚

- **å„ªé»**ï¼š
    - è§£è€¦ï¼šå°‡æˆæ¬Šé‚è¼¯å¾ Controller ä¸­åˆ†é›¢å‡ºä¾†ã€‚
    
    - å¯é‡ç”¨ï¼šç­–ç•¥å¯ä»¥åœ¨å¤šå€‹åœ°æ–¹é‡è¤‡ä½¿ç”¨ã€‚
    
    - å¯æ¸¬è©¦ï¼šç­–ç•¥å’Œè™•ç†å™¨æ›´å®¹æ˜“é€²è¡Œå–®å…ƒæ¸¬è©¦ã€‚


#### é…ç½®åŸºæ–¼ç­–ç•¥çš„æˆæ¬Š

1. **åœ¨ `Program.cs` ä¸­å®šç¾©ç­–ç•¥**ï¼š
```csharp
// Program.cs
var builder = WebApplication.CreateBuilder(args);

// ... é©—è­‰é…ç½® (ä¾‹å¦‚ AddCookie) ...

builder.Services.AddAuthorization(options =>
{
    // ç­–ç•¥ 1ï¼šè¦æ±‚ç”¨æˆ¶å¿…é ˆæ˜¯ Admin è§’è‰²
    options.AddPolicy("RequireAdminRole", policy =>
        policy.RequireRole("Admin"));

    // ç­–ç•¥ 2ï¼šè¦æ±‚ç”¨æˆ¶å¿…é ˆæœ‰ "Department" è²æ˜ä¸”å€¼ç‚º "HR"
    options.AddPolicy("RequireHRDepartment", policy =>
        policy.RequireClaim("Department", "HR"));

    // ç­–ç•¥ 3ï¼šè¦æ±‚ç”¨æˆ¶å¹´é½¡å¿…é ˆå¤§æ–¼ç­‰æ–¼ 18 æ­² (éœ€è¦è‡ªè¨‚ Requirement å’Œ Handler)
    options.AddPolicy("MinimumAge18", policy =>
        policy.Requirements.Add(new MinimumAgeRequirement(18)));
});

// è¨»å†Šè‡ªè¨‚è¦æ±‚è™•ç†å™¨ (å¦‚æœæœ‰çš„è©±)
builder.Services.AddSingleton<IAuthorizationHandler, MinimumAgeHandler>(); // è‡ªè¨‚è™•ç†å™¨å¿…é ˆè¨»å†Šç‚ºæœå‹™

// ...
```

2. **è‡ªè¨‚æˆæ¬Šè¦æ±‚ (Requirement) å’Œè™•ç†å™¨ (Handler) ç¯„ä¾‹**ï¼š
```csharp
// Authorization/MinimumAgeRequirement.cs
using Microsoft.AspNetCore.Authorization;

public class MinimumAgeRequirement : IAuthorizationRequirement
{
    public int MinimumAge { get; }

    public MinimumAgeRequirement(int minimumAge)
    {
        MinimumAge = minimumAge;
    }
}

// Authorization/MinimumAgeHandler.cs
using Microsoft.AspNetCore.Authorization;
using System.Security.Claims;
using System.Threading.Tasks;

public class MinimumAgeHandler : AuthorizationHandler<MinimumAgeRequirement>
{
    protected override Task HandleRequirementAsync(AuthorizationHandlerContext context, MinimumAgeRequirement requirement)
    {
        // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æœ‰ "DateOfBirth" è²æ˜
        if (!context.User.HasClaim(c => c.Type == ClaimTypes.DateOfBirth))
        {
            return Task.CompletedTask; // æ²’æœ‰å‡ºç”Ÿæ—¥æœŸè²æ˜ï¼Œä¸æ»¿è¶³è¦æ±‚
        }

        var dateOfBirth = Convert.ToDateTime(context.User.FindFirst(c => c.Type == ClaimTypes.DateOfBirth).Value);
        var age = DateTime.Today.Year - dateOfBirth.Year;
        if (dateOfBirth.Date > DateTime.Today.AddYears(-age)) age--; // è™•ç†ç”Ÿæ—¥é‚„æœªåˆ°çš„æƒ…æ³

        if (age >= requirement.MinimumAge)
        {
            context.Succeed(requirement); // æ»¿è¶³è¦æ±‚ï¼Œæˆæ¬ŠæˆåŠŸ
        }
        return Task.CompletedTask;
    }
}
```

3. **åœ¨ Controller/Action ä¸­ä½¿ç”¨ç­–ç•¥**ï¼š
```csharp
// Controllers/ContentController.cs
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

public class ContentController : Controller
{
    [Authorize(Policy = "RequireAdminRole")] // ä½¿ç”¨å®šç¾©å¥½çš„ç­–ç•¥
    public IActionResult AdminDashboard()
    {
        return View();
    }

    [Authorize(Policy = "RequireHRDepartment")]
    public IActionResult HRData()
    {
        return View();
    }

    [Authorize(Policy = "MinimumAge18")]
    public IActionResult AdultContent()
    {
        return View();
    }
}
```

### 3. åŸºæ–¼è²æ˜çš„æˆæ¬Š (Claims-based Authorization)

- è²æ˜æ˜¯é—œæ–¼ä¸»é«” (Principal) çš„ä¸€æ¢é™³è¿°ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ¶çš„å§“åã€é›»å­éƒµä»¶ã€è§’è‰²ã€å¹´é½¡ã€éƒ¨é–€ç­‰éƒ½å¯ä»¥æ˜¯è²æ˜ã€‚

- é€™æ˜¯æœ€ç´°ç²’åº¦çš„æˆæ¬Šæ–¹å¼ï¼Œå› ç‚ºæ‚¨å¯ä»¥æ ¹æ“šç”¨æˆ¶çš„ä»»ä½•è²æ˜ä¾†å®šç¾©æˆæ¬Šè¦å‰‡ã€‚

- ç­–ç•¥æˆæ¬Šæ­£æ˜¯åŸºæ–¼è²æ˜æˆæ¬Šçš„å»¶ä¼¸ï¼Œæä¾›äº†æ›´çµæ§‹åŒ–å’Œå¯æ“´å±•çš„æ–¹å¼ä¾†ä½¿ç”¨è²æ˜ã€‚

---
## âš ï¸ å¸¸è¦‹çš„å®‰å…¨è­°é¡Œ

é™¤äº†èº«ä»½é©—è­‰å’Œæˆæ¬Šï¼ŒASP.NET Core é‚„æä¾›äº†è¨±å¤šå…§å»ºåŠŸèƒ½å’Œæœ€ä½³å¯¦è¸ä¾†å¹«åŠ©æ‚¨ä¿è­·æ‡‰ç”¨ç¨‹å¼ï¼š

1. **CSRF (Cross-Site Request Forgery) è·¨ç«™è«‹æ±‚å½é€ **ï¼š
    
    - ASP.NET Core å…§å»ºäº† CSRF é˜²è­·ã€‚å°æ–¼åŒ…å«è¡¨å–®çš„ POST è«‹æ±‚ï¼Œä½¿ç”¨ `[ValidateAntiForgeryToken]` ç‰¹æ€§ã€‚
    
    - åœ¨ View ä¸­ä½¿ç”¨ `@Html.AntiForgeryToken()` æˆ– `<form asp-action="PostAction" asp-controller="ControllerName" method="post">`ã€‚

2. **XSS (Cross-Site Scripting) è·¨ç«™è…³æœ¬æ”»æ“Š**ï¼š
    
    - Razor View Engine æœƒè‡ªå‹•å°è¼¸å‡ºé€²è¡Œ HTML ç·¨ç¢¼ (`@variable`)ï¼Œå¾è€Œé˜²æ­¢åå°„å‹ XSSã€‚
    
    - å°æ–¼ç”¨æˆ¶è¼¸å…¥ï¼Œå§‹çµ‚é€²è¡Œ**è¼¸å…¥é©—è­‰å’Œè¼¸å‡ºç·¨ç¢¼**ã€‚

3. **SQL æ³¨å…¥ (SQL Injection)**ï¼š
    
    - ä½¿ç”¨ EF Core æˆ–å…¶ä»– ORM (Object-Relational Mapper) æ™‚ï¼Œå®ƒå€‘æœƒè‡ªå‹•åƒæ•¸åŒ–æŸ¥è©¢ï¼Œå¾è€Œæœ‰æ•ˆé˜²æ­¢ SQL æ³¨å…¥ã€‚
    
    - **é¿å…**æ‰‹å‹•æ‹¼æ¥ SQL æŸ¥è©¢å­—ä¸²ã€‚

4. **æ•æ„Ÿæ•¸æ“šä¿è­· (Data Protection)**ï¼š
    
    - ASP.NET Core çš„æ•¸æ“šä¿è­· API ç”¨æ–¼åŠ å¯†å’Œè§£å¯†æ‡‰ç”¨ç¨‹å¼æ•¸æ“šï¼Œä¾‹å¦‚ Cookieã€CSRF Token ç­‰ã€‚
    
    - åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œæ‡‰é…ç½®æ•¸æ“šä¿è­·é‡‘é‘°çš„æŒä¹…åŒ–å„²å­˜ï¼ˆä¾‹å¦‚ Azure Key Vaultã€Redisã€æª”æ¡ˆç³»çµ±ï¼‰ã€‚

5. **HTTPS å¼·åˆ¶å•Ÿç”¨ (HTTPS Enforcement)**ï¼š
    
    - ä½¿ç”¨ `app.UseHttpsRedirection()` å’Œ `app.UseHsts()` ä¸­ä»‹è»Ÿé«”ä¾†å¼·åˆ¶æ‰€æœ‰æµé‡ä½¿ç”¨ HTTPSã€‚
    
    - åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œé€™æ˜¯å¿…é ˆçš„ï¼Œä»¥é˜²æ­¢æ•¸æ“šåœ¨å‚³è¼¸éç¨‹ä¸­è¢«ç«Šè½ã€‚

6. **CORS (Cross-Origin Resource Sharing) è·¨åŸŸè³‡æºå…±äº«**ï¼š
    
    - ç•¶å‰ç«¯æ‡‰ç”¨ç¨‹å¼ (ä¾‹å¦‚ SPA) éƒ¨ç½²åœ¨èˆ‡ API ä¸åŒçš„ç¶²åŸŸæ™‚ï¼Œéœ€è¦é…ç½® CORS ç­–ç•¥ä¾†å…è¨±è·¨åŸŸè«‹æ±‚ã€‚
    
    - ä½¿ç”¨ `builder.Services.AddCors()` å’Œ `app.UseCors()`ã€‚

```csharp
// Program.cs
var MyAllowSpecificOrigins = "_myAllowSpecificOrigins"; // å®šç¾©ç­–ç•¥åç¨±

builder.Services.AddCors(options =>
{
    options.AddPolicy(name: MyAllowSpecificOrigins,
                      builder =>
                      {
                          builder.WithOrigins("http://example.com",
                                              "http://www.contoso.com")
                                 .AllowAnyHeader()
                                 .AllowAnyMethod();
                      });
});

// ...

var app = builder.Build();

// ...
app.UseRouting(); // æ”¾åœ¨ UseCors ä¹‹å‰

app.UseCors(MyAllowSpecificOrigins); // åœ¨ UseAuthorization ä¹‹å‰

app.UseAuthentication();
app.UseAuthorization();
// ...
```

---
## ğŸ”— ç›¸é—œå¡ç‰‡

- [[011.6-CoreMVC-ä¾è³´æ³¨å…¥èˆ‡æœå‹™è¨»å†Š]] (é©—è­‰èˆ‡æˆæ¬Šæœå‹™éƒ½åœ¨ DI å®¹å™¨ä¸­è¨»å†Š)
- [[011.9-CoreMVC-çµ„æ…‹ç®¡ç†èˆ‡ç’°å¢ƒè¨­å®š (Configuration)]] (JWT å¯†é‘°ã€ç™»å…¥è·¯å¾‘ç­‰é…ç½®)
- [[011.12-CoreMVC-éŒ¯èª¤è™•ç†èˆ‡ä¸­ä»‹è»Ÿé«” (Middleware)]] (é©—è­‰å’Œæˆæ¬Šéƒ½æ˜¯ä¸­ä»‹è»Ÿé«”ç®¡é“çš„ä¸€éƒ¨åˆ†)
- [[011.16-CoreMVC-éƒ¨ç½²èˆ‡ç¶­è­· (Deployment & Maintenance)]] (å®‰å…¨æ€§æ˜¯éƒ¨ç½²çš„é—œéµè€ƒé‡)