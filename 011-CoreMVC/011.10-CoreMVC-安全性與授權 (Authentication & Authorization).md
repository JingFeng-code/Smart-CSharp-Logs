---
title: 🔐 011.10-CoreMVC-安全性與授權 (Authentication & Authorization)
tags:
  - ASP.NET Core
  - MVC
  - 身分驗證
  - 授權
  - 安全性
aliases:
  - CoreMVC 安全性
  - ASP.NET Core 授權
created: 2025-07-02
updated: 2025-07-02
status: 草稿
summary: 介紹 ASP.NET Core MVC 的身分驗證（Authentication）、授權（Authorization）、常見安全性威脅防護與最佳實務，協助建立安全的現代 Web 應用。
---

## 🔐 驗證與授權基本概念

- **身分驗證（Authentication）**：確認使用者身分，例如登入、註冊、外部登入（Google、Facebook）等。
- **授權（Authorization）**：判斷已驗證的使用者是否有權存取特定資源（如頁面、API、動作）。
- ASP.NET Core 內建 **Identity** 系統，支援用戶管理、角色、權限、密碼雜湊、兩步驟驗證等。

---

## 🛠️ ASP.NET Core Identity 核心元件

- **UserManager**：管理使用者（建立、查詢、更新、刪除）。
- **RoleManager**：管理角色（建立、查詢、分配給使用者）。
- **SignInManager**：處理登入、登出、兩步驟驗證、外部登入。
- **IdentityUser/IdentityRole**：預設用戶與角色資料結構，可擴充自訂欄位。

---

## 🗝️ 授權類型與實作方式

| 類型                | 實作方式與範例                                             | 適用情境           |
|:-------------------|:----------------------------------------------------------|:------------------|
| 角色型授權         | `[Authorize(Roles = "Admin,Manager")]`                    | 管理後台、分層權限[1][4] |
| 原則型授權         | `[Authorize(Policy = "CanEdit")]`                         | 複雜條件、動態權限[4]   |
| Claims 型授權      | `[Authorize(Policy = "HasEmployeeNumber")]`               | 基於用戶屬性[4]        |
| 指定驗證方案       | `[Authorize(AuthenticationSchemes = "MyScheme")]`         | 多登入方式[5]          |

- **角色型授權**：依角色分配權限，適合組織分層管理。
- **原則型授權**：可組合多條件，彈性高，常用於複雜商業邏輯。
- **Claims 型授權**：根據用戶特定屬性（如員工編號、部門）判斷權限。
- **指定驗證方案**：支援多種驗證方式（如 Cookie、JWT、OAuth）。

---

## 🔒 常見安全性威脅與防護

- **跨站腳本（XSS）**：Razor 預設自動編碼，避免直接輸出未處理的用戶輸入。
- **SQL Injection**：EF Core 預設使用參數化查詢，避免拼接 SQL。
- **跨站請求偽造（CSRF）**：MVC 表單預設啟用 AntiForgery Token，Controller 加註 `[ValidateAntiForgeryToken]`。
- **密碼加密與雜湊**：Identity 內建安全密碼儲存與驗證。
- **強制 HTTPS 與 HSTS**：於 `Program.cs` 啟用 `app.UseHttpsRedirection()` 與 HSTS。
- **Session 管理與逾時**：適當設定 Cookie 逾時、滑動過期等。
- **檔案上傳驗證**：限制副檔名、檔案大小，避免惡意檔案。
- **錯誤處理頁面**：避免將詳細例外資訊顯示給用戶。

---

## 📝 實作範例

### 1. 加入驗證與授權

- 註冊 Identity 服務（於 `Program.cs`）：

```csharp
builder.Services.AddDefaultIdentity<IdentityUser>()  
.AddRoles<IdentityRole>()  
.AddEntityFrameworkStores<ApplicationDbContext>();
```

- 套用授權屬性於 Controller 或 Action：

```csharp
[Authorize]  
public class AdminController : Controller { ... }

[Authorize(Roles = "Manager")]  
public IActionResult Manage() { ... }

[Authorize(Policy = "CanEdit")]  
public IActionResult Edit() { ... }
```

### 2. 設定授權原則（Policy）

```csharp
builder.Services.AddAuthorization(options =>  
{  
	options.AddPolicy("CanEdit", policy =>  
	policy.RequireRole("Admin", "Editor")  
	.RequireClaim("Department", "HR"));  
});
```

### 3. 使用 UserManager/SignInManager

```csharp
public class AccountController : Controller  
{  
	private readonly UserManager<IdentityUser> _userManager;  
	private readonly SignInManager<IdentityUser> _signInManager;
	public AccountController(UserManager<IdentityUser> userManager, SignInManager<IdentityUser> signInManager)
	{
	    _userManager = userManager;
	    _signInManager = signInManager;
	}
// 註冊、登入、登出等邏輯
}
```

---
## 🏆 安全性最佳實務

- **強制 HTTPS**，避免敏感資料明文傳輸。
- **最小權限原則**，僅授予必要權限給用戶/角色。
- **密碼強度與多因素驗證**，提升帳號安全。
- **定期更新套件與安全修補**，避免已知漏洞。
- **日誌與稽核**，記錄重要操作與異常事件。
- **自訂錯誤頁面**，避免資訊洩漏。

---
## 🔍 延伸學習資源

- [Microsoft Learn：ASP.NET Core 角色型授權][1]
- [ASP.NET Core Identity 官方教學][3][8]
- [10 Best Practices to Secure ASP.NET Core MVC][2]
- [Policy-based Authorization in .NET Core][4]

---
## 🔗 相關卡片

- [[011.9-CoreMVC-錯誤處理與中介軟體 (Middleware)]]
- [[011.11-CoreMVC-效能優化與快取]]
- [[011.12-CoreMVC-單元測試與自動化]]



