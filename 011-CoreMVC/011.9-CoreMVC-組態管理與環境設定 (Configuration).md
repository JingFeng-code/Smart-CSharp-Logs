---
title: ⚙️ 011.9-CoreMVC-組態管理與環境設定 (Configuration)
tags:
  - ASP-NET
  - Core
  - MVC
  - 組態
  - 環境變數
  - 安全性
aliases:
  - ASP.NET Core Configuration
  - appsettings.json
  - 環境設定
created: 2025-07-07
updated: 2025-07-07
status: 草稿
summary: 深入探討 ASP.NET Core MVC 中組態管理的核心機制，包括不同組態來源、優先順序、強型別綁定與環境設定，以實現靈活且安全的應用程式配置。
---

## ⚙️ 什麼是組態管理？為何它如此重要？

想像一個應用程式就像一家餐廳。餐廳需要各種「設定」才能正常運作：營業時間、供應商資訊、菜單價格、甚至是否播放背景音樂等等。這些設定在開發、測試、正式營運等不同階段可能會有所不同。

在 ASP.NET Core 中，**組態管理 (Configuration)** 就是處理這些應用程式「設定」的機制。它允許開發者以靈活、可擴展且安全的方式，載入和管理應用程式運行時所需的各種參數。

組態管理之所以重要，是因為它能：

1.  **環境適應性**：讓應用程式在不同環境（開發、測試、生產）下使用不同的設定，例如連接不同的資料庫、呼叫不同的 API 位址。
2.  **彈性與可維護性**：無需重新編譯程式碼，就能修改應用程式行為，大大提高了系統的彈性與日後維護的便利性。
3.  **安全性**：將敏感資訊（如資料庫連線字串、API 金鑰）從程式碼中分離出來，避免硬編碼，並提供安全的儲存方式。

---

## 💡 ASP.NET Core 的組態來源與優先順序

ASP.NET Core 的組態系統非常強大且靈活，它能從多個來源讀取設定，並依照預設的**優先順序**來決定哪個設定值最終生效。這就像你的餐廳設定有多個「備忘錄」來源：

1.  **`appsettings.json`**：
    * 這是最常用的基礎組態檔案，通常用於儲存應用程式的預設設定。
    * 支援 JSON 格式，易於閱讀和結構化，可以包含巢狀結構。
    * 例如：`"ConnectionStrings": { "DefaultConnection": "..." }`

2.  **`appsettings.{EnvironmentName}.json`**：
    * 針對特定環境（如 `appsettings.Development.json`、`appsettings.Production.json`）的組態檔。
    * **優先級高於 `appsettings.json`**：如果兩個檔案有相同設定，特定環境的設定會覆蓋預設設定。
    * 環境名稱由 `ASPNETCORE_ENVIRONMENT` 環境變數決定。

3.  **環境變數 (Environment Variables)**：
    * 系統級別的設定，**優先級高於 `appsettings.json` 系列檔案**。
    * 特別適用於部署到 Docker 容器、雲端平台（如 Azure App Service）或 CI/CD 管線中設定敏感資訊或特定環境值。
    * 例如：設定 `ASPNETCORE_ENVIRONMENT=Production`。
    * ASP.NET Core 會將環境變數名稱中的雙底線 `__` 轉換為 JSON 結構中的冒號 `:`。例如 `ConnectionStrings__DefaultConnection` 會對應到 JSON 中的 `"ConnectionStrings": { "DefaultConnection": ... }`。

4.  **命令列參數 (Command-line arguments)**：
    * 在啟動應用程式時，直接透過命令列傳遞的參數。
    * **優先級最高**：它們會覆蓋所有其他來源的設定。
    * 例如：`dotnet run --ConnectionStrings:DefaultConnection="NewValue"`

5.  **使用者密碼 (User Secrets)**：
    * 專為**開發環境**設計，用於儲存敏感資料（如 API 金鑰、開發資料庫密碼），且不會被提交到原始碼控制系統（如 Git）。
    * 儲存在使用者配置檔中，避免敏感資訊洩露。
    * 在專案資料夾執行 `dotnet user-secrets init` 初始化，然後 `dotnet user-secrets set "Key" "Value"`。

6.  **Azure Key Vault / HashiCorp Vault 等外部服務**：
    * 對於生產環境的極度敏感資訊，推薦使用專業的金鑰管理服務。
    * 這些服務能提供更安全的儲存、版本控制和存取權限管理。

**總結優先順序 (由低到高)：**
`appsettings.json` < `appsettings.{Environment}.json` < 環境變數 < 命令列參數 < 使用者密碼 (開發環境) < 外部金鑰管理服務

---

### **💭 應用情境思考：**
一個開發中的應用程式，其資料庫連線字串在開發環境和生產環境不同。此外，開發者不希望將開發環境的敏感連線字串提交到 Git 倉庫。應用程式應該如何配置這些連線字串，以達到靈活性和安全性？

---

## 🔑 程式碼中如何讀取組態？

在 ASP.NET Core 應用程式中，組態資訊會被載入到 `IConfiguration` 介面中，這個介面可以透過依賴注入 (DI) 在各個組件中使用。

1. **直接讀取**： 
	* 適用於讀取單一的、簡單的設定值。

```csharp
// 透過 DI 取得 IConfiguration 實例
public class MyService
{
    private readonly IConfiguration _configuration;

	public MyService(IConfiguration configuration)
    {
        _configuration = configuration;
    }

	public void DoSomething()
    {
        // 讀取一個字串值
        string connectionString = _configuration["ConnectionStrings:DefaultConnection"];
	    // 讀取一個巢狀值
        string apiKey = _configuration["ApiKeys:MyServiceKey"]; 
        // 讀取一個數字值 (需要轉換)
        int logLevel = int.Parse(_configuration["Logging:LogLevel:Default"]); 
        }
    }
```

2. **強型別綁定 (Options Pattern)**：
	* **推薦的做法**，尤其當組態結構複雜或需要頻繁使用時。
	* 將相關組態綁定到一個 C# 物件上，提供編譯時的型別檢查和智能提示。
	* **步驟：**

`1. 定義一個類別來代表組態區塊。`
```csharp
// 例如，定義一個郵件服務設定的類別
public class EmailSettings
{
    public string SmtpServer { get; set; }
    public int Port { get; set; }
    public string SenderName { get; set; }
}
```
`2. 在 Program.cs 或 Startup.cs 中註冊組態服務並綁定。`
```csharp
    // Program.cs (Minimal API / .NET 6+)
    var builder = WebApplication.CreateBuilder(args);

    // 將 "EmailSettings" 區塊綁定到 EmailSettings 類別
    builder.Services.Configure<EmailSettings>(
        builder.Configuration.GetSection("EmailSettings"));

    // Startup.cs (舊版 .NET 5-)
    // public void ConfigureServices(IServiceCollection services)
    // {
    //     services.Configure<EmailSettings>(Configuration.GetSection("EmailSettings"));
    // }
```
`3.  在需要使用的類別中透過 DI 注入 IOptions<T>。`
```csharp
public class EmailService
{
    private readonly EmailSettings _emailSettings;

    // 注入 IOptions<EmailSettings>
    public EmailService(IOptions<EmailSettings> emailSettingsOptions)
    {
	    _emailSettings = emailSettingsOptions.Value; // 取得設定物件
    }

    public void SendEmail()
    {
        Console.WriteLine($"Sending email via {_emailSettings.SmtpServer}:{_emailSettings.Port}");
    }
}
```
`* **優點**：程式碼更清晰、可讀性高，減少字串魔法，並在編譯時期捕獲潛在錯誤。`

---
## 🌍 環境設定 (Environment)

ASP.NET Core 透過 **`ASPNETCORE_ENVIRONMENT` 環境變數**來識別當前的運行環境。這對管理不同環境下的行為至關重要。

* **常見的環境名稱**：
    * `Development` (開發)
    * `Staging` (預生產/測試)
    * `Production` (生產)
* **如何設定環境變數**：
    * **Windows**：`set ASPNETCORE_ENVIRONMENT=Development` (cmd) 或 `$env:ASPNETCORE_ENVIRONMENT="Development"` (PowerShell)
    * **Linux/macOS**：`export ASPNETCORE_ENVIRONMENT=Development`
    * **`launchSettings.json`**：在 Visual Studio 或 `dotnet run` 啟動時，通常會使用這個檔案來設定開發環境的環境變數。

    ```json
    // launchSettings.json 範例
    {
      "profiles": {
        "MyProject": {
          "commandName": "Project",
          "environmentVariables": {
            "ASPNETCORE_ENVIRONMENT": "Development" // 在這裡設定開發環境
          }
        }
      }
    }
    ```
* **在程式碼中判斷環境**：
    * 使用 `IWebHostEnvironment` 或 `IHostEnvironment` 介面。
    ```csharp
    public class Startup // 或 Program.cs
    {
        private readonly IWebHostEnvironment _env;

        public Startup(IConfiguration configuration, IWebHostEnvironment env)
        {
            Configuration = configuration;
            _env = env;
        }

        public IConfiguration Configuration { get; }

        public void Configure(IApplicationBuilder app)
        {
            if (_env.IsDevelopment()) // 判斷是否為開發環境
            {
                app.UseDeveloperExceptionPage();
            }
            else if (_env.IsProduction()) // 判斷是否為生產環境
            {
                // 設定生產環境特有的中間件或行為
            }
            // ...
        }
    }
    ```
    * `IsDevelopment()`, `IsStaging()`, `IsProduction()` 都是 `IWebHostEnvironment` 的擴充方法。

---
## 🔗 相關卡片

- [[011.1-CoreMVC-框架介紹與專案結構]]
- [[011.10-CoreMVC-日誌記錄與監控 (Logging)]] (日誌級別也常透過組態管理)
- [[011.15-CoreMVC-部署與維運]] (部署時的組態管理策略)

---