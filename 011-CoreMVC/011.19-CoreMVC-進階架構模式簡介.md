---
title: 🏗️ 011.19-CoreMVC-進階架構模式簡介
tags:
  - ASP-NET
  - Core
  - 架構模式
  - Architecture-Patterns
  - Onion-Architecture
  - Clean-Architecture
  - DDD
  - CQRS
  - Microservices
  - Repository-Pattern
  - Service-Layer
  - DI
aliases:
  - CoreMVC 架構
  - ASP.NET Core 進階設計
  - 應用程式架構
created: 2025-07-10
updated: 2025-07-10
status: 完成
summary: 本筆記簡要介紹 ASP.NET Core MVC 應用程式中常用的進階架構模式。內容涵蓋分層架構、洋蔥架構 (Onion Architecture)、整潔架構 (Clean Architecture)、領域驅動設計 (DDD)、命令查詢職責分離 (CQRS) 等概念，以及微服務架構的初步認識，旨在協助開發者理解如何選擇和應用這些模式來建構可擴展、可維護且業務複雜度高的應用程式。
---

隨著 ASP.NET Core MVC 應用程式的規模和複雜度不斷增加，僅僅依賴 MVC 模式本身可能不足以有效地管理程式碼、確保可維護性和促進團隊協作。此時，引入**進階架構模式 (Advanced Architectural Patterns)** 就變得至關重要。這些模式提供了一套原則和最佳實踐，旨在幫助開發者組織程式碼，解耦關注點，並使應用程式更具彈性以應對需求變化。

本卡片將簡要介紹一些在 ASP.NET Core 應用程式中常見且有益的進階架構模式。

---

## 1. 分層架構 (Layered Architecture)

分層架構是最基本也是最常見的架構模式。它將應用程式劃分為多個邏輯層，每層負責特定的職責，並且層與層之間通常只能單向依賴（上層依賴下層）。

- **常見的分層**：
    
    - **表現層 (Presentation Layer)**：
        
        - 負責使用者介面和與用戶的交互。
        
        - 在 ASP.NET Core MVC 中，這通常是 **MVC Controller 和 Views**。

    - **應用層 (Application Layer)**：
        
        - 協調業務操作流程，處理來自表現層的請求，並委派給領域層。
            
        - 負責事務管理、應用程式級別的驗證、安全檢查等。
            
        - 通常包含 **Application Services (應用服務)**。

    - **領域層 (Domain Layer)**：
        
        - 包含核心業務邏輯、領域模型、領域規則。
            
        - 是應用程式的**心臟**，不應依賴於其他層。
            
        - 通常包含 **領域模型 (Domain Models)、實體 (Entities)、值對象 (Value Objects)、聚合 (Aggregates)、領域服務 (Domain Services)**。

    - **基礎設施層 (Infrastructure Layer)**：
        
        - 提供通用技術支持，如數據持久化（資料庫訪問）、日誌記錄、外部服務集成、快取等。
            
        - 負責實現領域層和應用層定義的接口。
            
        - 通常包含 **Repository 實現、ORM (如 Entity Framework Core) 配置、Helper 類別**。

- **優點**：清晰的職責分離、易於理解、有利於團隊分工。

- **缺點**：嚴格的分層可能導致過多的層級穿越、維護數據庫 schema 變化可能影響多層。


---

## 2. 洋蔥架構 (Onion Architecture)

洋蔥架構由 Jeffrey Palermo 提出，旨在改進傳統分層架構的缺點，特別是將依賴關係倒置 (Dependency Inversion Principle) 作為核心原則。它的核心思想是將**領域層**放在最中心，外部層次依賴內部層次，但內部層次絕不依賴外部層次。

- **核心原則**：
    
    - **領域模型**是核心，不依賴任何外部基礎設施。
    
    - 外部層次依賴內部層次。
    
    - 應用程式的**所有依賴都指向中心**。
    
    - 接口定義在內部層次，實現則在外部層次。

- **典型結構（從內到外）**：
    
    - **領域核心 (Domain Core)**：定義所有實體、值對象、聚合根、領域服務介面、倉儲介面。完全獨立於其他層。
    
    - **應用服務 (Application Services)**：協調領域對象，實現應用程式特定用例。依賴於領域核心。
    
    - **基礎設施 (Infrastructure)**：實現領域核心中定義的倉儲介面、提供外部服務（如資料庫訪問、郵件發送）。依賴於領域核心。
    
    - **使用者介面 (UI)**：如 ASP.NET Core MVC 專案，用於展示和與用戶交互。依賴於應用服務。

- **優點**：
    
    - **高解耦性**：核心業務邏輯獨立於框架和基礎設施。
    
    - **可測試性**：領域層和應用層可以輕鬆地進行單元測試，無需依賴具體的資料庫或外部服務。
    
    - **可替換性**：可以輕鬆替換資料庫、Web 框架等基礎設施組件。

- **缺點**：對於小型應用程式可能過於複雜。
    

---

## 3. 整潔架構 (Clean Architecture)

由 Robert C. Martin (Uncle Bob) 提出，與洋蔥架構有異曲同工之妙，但更為通用和廣泛。它強調**關注點分離**，同樣將業務規則放在中心，並將外部依賴（如 UI、資料庫、框架）放在外圍。

- **核心原則**：
    
    - **獨立於框架**：架構不應該依賴於某些程式庫的存在。
    
    - **可測試**：業務規則可以在沒有 UI、資料庫、Web 服務等的情況下進行測試。
    
    - **獨立於 UI**：UI 可以輕鬆更改，而無需更改系統的其餘部分。
    
    - **獨立於資料庫**：可以在不更改業務規則的情況下換用不同的資料庫。
    
    - **獨立於任何外部代理**：業務規則不知道其數據是從哪裡來的。
    
- **典型的同心圓結構（從內到外）**：
    
    - **Entities (實體)**：企業級業務規則。
    
    - **Use Cases (用例)**：應用程式特有的業務規則。
    
    - **Interface Adapters (介面適配器)**：將內圈的通用數據格式轉換為外圈框架所需的格式（如 Controller、Presenter、Gateway）。
    
    - **Frameworks & Drivers (框架與驅動)**：最外層，包含 Web 框架、資料庫、外部服務等。

- **實踐**：在 ASP.NET Core 中實現整潔架構，通常會創建多個專案：
    
    - `ApplicationName.Domain` (Entities)
    
    - `ApplicationName.Application` (Use Cases)
    
    - `ApplicationName.Infrastructure` (實現 Gateway, Repository)
    
    - `ApplicationName.Web` (UI/Interface Adapters, Composition Root)

- **優點**：與洋蔥架構類似，高可維護性、可測試性、彈性。

- **缺點**：引入更多抽象，對開發者要求更高，初期開發成本較高。


---

## 4. 領域驅動設計 (Domain-Driven Design, DDD)

DDD 是一種軟體開發方法，它強調將軟體設計與**核心業務領域**緊密結合。它不是一個具體的架構模式，而是一套設計原則和模式的集合，可以與分層、洋蔥、整潔等架構模式結合使用。

- **核心概念**：
    
    - **領域 (Domain)**：應用程式所處理的特定業務範圍。
    
    - **通用語言 (Ubiquitous Language)**：開發者和領域專家共享的一套語言，用來描述領域概念。
    
    - **聚合 (Aggregate)**：一組相關的對象，被視為一個單一的單元進行數據變更。有一個聚合根 (Aggregate Root) 作為外部訪問入口。
    
    - **實體 (Entity)**：有唯一標識符和生命週期的對象。
    
    - **值對象 (Value Object)**：通過屬性值定義相等性，無唯一標識符，通常不可變。
    
    - **領域服務 (Domain Service)**：執行跨多個實體或值對象的領域邏輯，這些邏輯不屬於任何單個實體。
    
    - **倉儲 (Repository)**：用於從持久化儲存中讀取和寫入聚合根的介面。
    
    - **界限上下文 (Bounded Context)**：一個明確的邊界，其中特定的領域模型和通用語言是有效的。

- **優點**：
    
    - 更好地理解複雜業務領域。
    
    - 創建更貼近業務現實的程式碼。
    
    - 提高程式碼的可理解性和可維護性。
    
- **缺點**：學習曲線陡峭，對於簡單的 CRUD 應用可能過度設計。

---
## 5. 命令查詢職責分離 (Command Query Responsibility Segregation, CQRS)

CQRS 是一種架構模式，它將應用程式的**寫操作 (Command)** 和**讀操作 (Query)** 分離到不同的模型和/或服務中。

- **核心思想**：
    
    - **命令 (Commands)**：修改系統狀態的操作，不返回數據，只返回成功或失敗的狀態。
    
    - **查詢 (Queries)**：從系統中讀取數據的操作，不修改系統狀態。
    
    - 通常，**寫模型 (Write Model)** 可能是一個複雜的 DDD 聚合，用於處理業務規則和數據一致性。
    
    - **讀模型 (Read Model)** 則是一個簡單的、針對查詢優化的數據結構（可能是扁平化的數據或預先計算的視圖）。

- **常見實踐**：
    
    - 讀寫使用不同的資料庫或不同的資料庫 schema。
    
    - 使用消息佇列或事件來同步讀寫模型。
    
    - MediatR 是一個流行的 .NET 庫，用於實現 CQRS 中的發送命令和查詢。
    
- **優點**：
    
    - **讀寫性能優化**：可以為讀和寫操作獨立擴展和優化。
    
    - **簡化複雜性**：讀模型通常比寫模型簡單，提高查詢效率。
    
    - **更好的擴展性**：適合處理高併發的讀寫場景。
    
    - **關注點分離**：命令和查詢邏輯更清晰。

- **缺點**：
    
    - 增加系統複雜性（需要管理兩個模型）。
    
    - 數據一致性模型可能更複雜（最終一致性）。
    
    - 對於簡單的應用程式可能過度設計。

---

## 6. 微服務架構 (Microservices Architecture)

微服務是一種架構風格，它將一個大型的單體應用程式分解為一組小型、鬆耦合的服務，每個服務運行在自己的進程中，並通過輕量級機制（通常是 HTTP API）進行通信。

- **核心原則**：
    
    - **單一職責**：每個服務專注於一個獨立的業務功能。
    
    - **獨立部署**：每個服務可以獨立部署和升級。
    
    - **獨立技術棧**：不同服務可以使用不同的程式語言、框架和資料庫。
    
    - **去中心化**：去中心化的數據管理和治理。
    
    - **故障隔離**：一個服務的故障不影響整個系統。

- **ASP.NET Core 在微服務中的角色**：
    
    - 每個微服務都可以是一個獨立的 ASP.NET Core Web API 應用程式。
    
    - 可以使用 Docker 容器化每個服務，並通過 Kubernetes 等容器編排工具進行管理。

- **優點**：
    
    - **可擴展性**：可以獨立擴展每個服務。
    
    - **彈性**：一個服務的故障不影響其他服務。
    
    - **技術靈活性**：可以為每個服務選擇最適合的技術。
    
    - **團隊獨立性**：不同的團隊可以獨立開發和部署服務。

- **缺點**：
    
    - **分佈式系統複雜性**：服務間通信、數據一致性、日誌、監控、測試、部署都更複雜。
    
    - **運維成本高**：需要更多的基礎設施和運維投入。
    
    - **網絡延遲**：服務間通信會引入網絡延遲。


---
## 如何選擇和應用架構模式？

- **從簡單開始**：對於小型或初創專案，從一個清晰的分層 MVC 應用程式開始是明智的選擇。

- **逐步演進**：當業務複雜度增加時，逐步引入更進階的模式，例如：
    
    - 當業務邏輯變得複雜且需要獨立測試時，引入**Service 層**和 **Repository 模式**。
    
    - 當領域模型變得重要且需要與技術細節解耦時，考慮**洋蔥/整潔架構**或 **DDD** 的原則。
    
    - 當讀寫性能或模型差異變大時，考慮 **CQRS**。
    
    - 當應用程式龐大到難以管理，團隊規模擴大時，考慮**微服務**。

- **不要過度設計 (Don't Over-Engineer)**：為簡單的問題應用複雜的模式會增加不必要的複雜性和成本。

- **團隊熟悉度**：選擇團隊成員熟悉且能有效協作的模式。

- **可測試性優先**：任何選擇的架構模式都應該優先考慮程式碼的可測試性。

---
## 🔗 相關卡片

- [[011.6-CoreMVC-依賴注入與服務註冊]] (DI 是實現這些架構模式中解耦和測試的關鍵)
- [[011.7-CoreMVC-與資料庫整合 (EF Core)]] (Repository 模式與資料庫集成)
- [[011.15-CoreMVC-單元測試與自動化 (Unit Testing & Automation)]] (這些架構模式都旨在提升可測試性)
- [[011.16-CoreMVC-部署與維護 (Deployment & Maintenance)]] (微服務對部署和運維有顯著影響)
- [[011.17-CoreMVC-MVC 與 WebAPI 整合考量]] (微服務通常是 Web API 驅動的)