---
title: ğŸš§ 011.12-CoreMVC-éŒ¯èª¤è™•ç†èˆ‡ä¸­ä»‹è»Ÿé«” (Middleware)
tags:
  - ASP-NET
  - Core
  - éŒ¯èª¤è™•ç†
  - Exception-Handling
  - ä¸­ä»‹è»Ÿé«”
  - Middleware
  - é–‹ç™¼è€…ä¾‹å¤–é é¢
  - ç‹€æ…‹ç¢¼é é¢
aliases:
  - CoreMVC éŒ¯èª¤è™•ç†
  - CoreMVC Middleware
  - ASP.NET Core éŒ¯èª¤è™•ç†
created: 2025-07-10
updated: 2025-07-10
status: å®Œæˆ
summary: æœ¬ç­†è¨˜æ·±å…¥æ¢è¨ ASP.NET Core MVC ä¸­çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶å’Œä¸­ä»‹è»Ÿé«” (Middleware) çš„æ‡‰ç”¨ã€‚å…§å®¹æ¶µè“‹ä¸­ä»‹è»Ÿé«”ç®¡é“çš„åŸç†ã€å¦‚ä½•å»ºç«‹è‡ªè¨‚ä¸­ä»‹è»Ÿé«”ã€ä¸åŒç’°å¢ƒä¸‹çš„éŒ¯èª¤è™•ç†ç­–ç•¥ï¼ˆå¦‚é–‹ç™¼è€…ä¾‹å¤–é é¢ã€ç•°å¸¸è™•ç†ä¸­ä»‹è»Ÿé«”ï¼‰ï¼Œä»¥åŠå¦‚ä½•è™•ç† HTTP ç‹€æ…‹ç¢¼éŒ¯èª¤ï¼Œå”åŠ©é–‹ç™¼è€…å»ºæ§‹ç©©å®šä¸”ç”¨æˆ¶å‹å¥½çš„æ‡‰ç”¨ç¨‹å¼ã€‚
---

åœ¨ä»»ä½•æ‡‰ç”¨ç¨‹å¼ä¸­ï¼Œ**éŒ¯èª¤è™•ç† (Error Handling)** éƒ½æ˜¯ä¸å¯æˆ–ç¼ºçš„ä¸€ç’°ã€‚ç„¡è«–æ˜¯é æœŸçš„é©—è­‰å¤±æ•—ï¼Œé‚„æ˜¯éé æœŸçš„é‹è¡Œæ™‚ç•°å¸¸ï¼Œæ‡‰ç”¨ç¨‹å¼éƒ½éœ€è¦ä»¥ä¸€ç¨®å„ªé›…ä¸”å®‰å…¨çš„æ–¹å¼éŸ¿æ‡‰ï¼Œé¿å…ç›´æ¥æš´éœ²æ•æ„Ÿè³‡è¨Šçµ¦ä½¿ç”¨è€…ï¼ŒåŒæ™‚ç‚ºé–‹ç™¼è€…æä¾›è¶³å¤ çš„è¨ºæ–·è³‡è¨Šã€‚

ASP.NET Core é€éå…¶**ä¸­ä»‹è»Ÿé«” (Middleware)** ç®¡é“ï¼Œæä¾›äº†éˆæ´»ä¸”å¼·å¤§çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ã€‚ä¸­ä»‹è»Ÿé«”æ˜¯æ§‹æˆ ASP.NET Core è«‹æ±‚è™•ç†ç®¡é“çš„çµ„ä»¶ï¼Œæ¯å€‹ä¸­ä»‹è»Ÿé«”éƒ½å¯ä»¥é¸æ“‡è™•ç† HTTP è«‹æ±‚æˆ–å°‡å…¶å‚³éçµ¦ç®¡é“ä¸­çš„ä¸‹ä¸€å€‹ä¸­ä»‹è»Ÿé«”ã€‚

---

## ğŸ› ï¸ ä¸­ä»‹è»Ÿé«” (Middleware) æ¦‚è¿°

ä¸­ä»‹è»Ÿé«”æ˜¯ ASP.NET Core æ‡‰ç”¨ç¨‹å¼è™•ç†è«‹æ±‚å’ŒéŸ¿æ‡‰çš„æ ¸å¿ƒã€‚å®ƒå€‘ä»¥ç®¡é“ (Pipeline) çš„å½¢å¼çµ„ç¹”ï¼Œæ¯å€‹ä¸­ä»‹è»Ÿé«”åœ¨ç®¡é“ä¸­åŸ·è¡Œç‰¹å®šä»»å‹™ï¼Œä¾‹å¦‚ï¼š

- è·¯ç”± (Routing)
- èº«ä»½é©—è­‰ (Authentication)
- æˆæ¬Š (Authorization)
- æ—¥èªŒè¨˜éŒ„ (Logging)
- éŒ¯èª¤è™•ç† (Error Handling)
- éœæ…‹æª”æ¡ˆæœå‹™ (Serving Static Files)

### ä¸­ä»‹è»Ÿé«”ç®¡é“çš„é‹ä½œæ–¹å¼

ç•¶ä¸€å€‹ HTTP è«‹æ±‚é€²å…¥ ASP.NET Core æ‡‰ç”¨ç¨‹å¼æ™‚ï¼Œå®ƒæœƒä¾åºé€šéæ‚¨åœ¨ `Program.cs` ä¸­å®šç¾©çš„ä¸­ä»‹è»Ÿé«”ç®¡é“ã€‚

1. è«‹æ±‚é€²å…¥ç®¡é“çš„ç¬¬ä¸€å€‹ä¸­ä»‹è»Ÿé«”ã€‚
2. è©²ä¸­ä»‹è»Ÿé«”åŸ·è¡Œå…¶é‚è¼¯ï¼Œç„¶å¾Œå¯ä»¥é¸æ“‡ï¼š
    
    - å°‡è«‹æ±‚å‚³éçµ¦ç®¡é“ä¸­çš„ä¸‹ä¸€å€‹ä¸­ä»‹è»Ÿé«”ï¼ˆä½¿ç”¨ `next.Invoke()` æˆ– `await next()`ï¼‰ã€‚
    
    - çŸ­è·¯ (Short-circuit) ç®¡é“ï¼Œç›´æ¥ç”ŸæˆéŸ¿æ‡‰ä¸¦è¿”å›ï¼Œä¸å†å°‡è«‹æ±‚å‚³éçµ¦å¾ŒçºŒä¸­ä»‹è»Ÿé«”ã€‚

3. ç•¶è«‹æ±‚é€šéæ‰€æœ‰ä¸­ä»‹è»Ÿé«”ä¸¦åˆ°é”çµ‚é»ï¼ˆä¾‹å¦‚ MVC Controller Action æˆ– Minimal API Endpointï¼‰å¾Œï¼ŒéŸ¿æ‡‰æœƒæ²¿è‘—ç®¡é“**é€†å‘**è¿”å›ï¼Œé€”ç¶“æ¯å€‹ä¸­ä»‹è»Ÿé«”ï¼Œæ¯å€‹ä¸­ä»‹è»Ÿé«”éƒ½æœ‰æ©Ÿæœƒåœ¨éŸ¿æ‡‰ç™¼é€å›å®¢æˆ¶ç«¯ä¹‹å‰é€²è¡Œè™•ç†ã€‚

### åœ¨ `Program.cs` ä¸­é…ç½®ä¸­ä»‹è»Ÿé«”

ä¸­ä»‹è»Ÿé«”é€šå¸¸åœ¨ `Program.cs` çš„ `Configure` æ–¹æ³•ï¼ˆæˆ– `WebApplication` å¯¦ä¾‹ä¸Šï¼‰ä½¿ç”¨ `app.Use...()` æ“´å±•æ–¹æ³•ä¾†æ·»åŠ ã€‚**ä¸­ä»‹è»Ÿé«”çš„é †åºéå¸¸é‡è¦ï¼Œå› ç‚ºå®ƒæ±ºå®šäº†è«‹æ±‚è™•ç†çš„æµç¨‹ã€‚**

```csharp
// Program.cs
var builder = WebApplication.CreateBuilder(args);

// Add services to the container.
builder.Services.AddControllersWithViews();

var app = builder.Build();

// ä¸­ä»‹è»Ÿé«”é †åºå¾ˆé‡è¦ï¼

// 1. éŒ¯èª¤è™•ç†ä¸­ä»‹è»Ÿé«”é€šå¸¸æ”¾åœ¨ç®¡é“çš„å‰é¢ï¼Œä»¥ä¾¿æ•ç²å¾ŒçºŒä¸­ä»‹è»Ÿé«”ä¸­çš„ç•°å¸¸
if (app.Environment.IsDevelopment())
{
    app.UseDeveloperExceptionPage(); // é–‹ç™¼ç’°å¢ƒå°ˆç”¨çš„è©³ç´°éŒ¯èª¤é é¢
}
else
{
    // ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨å‹å–„çš„éŒ¯èª¤é é¢ï¼Œä¸¦å•Ÿç”¨ HSTS
    app.UseExceptionHandler("/Home/Error"); // æ•ç²æ‰€æœ‰æœªè™•ç†çš„ç•°å¸¸ä¸¦é‡å®šå‘åˆ°æŒ‡å®šè·¯å¾‘
    app.UseHsts(); // å•Ÿç”¨ HTTP Strict Transport Security
}

// 2. HTTPS é‡å®šå‘
app.UseHttpsRedirection();

// 3. éœæ…‹æª”æ¡ˆæœå‹™ (å…è¨±è¨ªå• wwwroot ä¸‹çš„éœæ…‹æ–‡ä»¶)
app.UseStaticFiles();

// 4. è·¯ç”± (å•Ÿç”¨è·¯ç”±åŠŸèƒ½)
app.UseRouting();

// 5. èº«ä»½é©—è­‰ (å¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼éœ€è¦ç”¨æˆ¶ç™»å…¥)
app.UseAuthentication();

// 6. æˆæ¬Š (å¦‚æœæ‚¨çš„æ‡‰ç”¨ç¨‹å¼éœ€è¦æ¬Šé™æ§åˆ¶)
app.UseAuthorization();

// 7. çµ‚é»è·¯ç”± (å°‡è«‹æ±‚æ˜ å°„åˆ° Controller Action æˆ– Minimal API)
app.MapControllerRoute(
    name: "default",
    pattern: "{controller=Home}/{action=Index}/{id?}");

app.Run();
```

---
## ğŸš§ éŒ¯èª¤è™•ç†ç­–ç•¥

ASP.NET Core æä¾›äº†å¤šç¨®éŒ¯èª¤è™•ç†æ–¹å¼ï¼Œæ‡‰æ ¹æ“šä¸åŒçš„ç’°å¢ƒï¼ˆé–‹ç™¼ã€ç”Ÿç”¢ï¼‰å’ŒéŒ¯èª¤é¡å‹ä¾†é¸æ“‡ã€‚

### 1. é–‹ç™¼ç’°å¢ƒï¼šé–‹ç™¼è€…ä¾‹å¤–é é¢ (`UseDeveloperExceptionPage`)

åœ¨é–‹ç™¼ç’°å¢ƒä¸­ï¼Œæ‚¨æœƒå¸Œæœ›çœ‹åˆ°è©³ç´°çš„éŒ¯èª¤è³‡è¨Šï¼ŒåŒ…æ‹¬å †ç–Šè¿½è¹¤ã€æŸ¥è©¢å­—ä¸²ã€Header ç­‰ï¼Œä»¥ä¾¿å¿«é€Ÿå®šä½å•é¡Œã€‚

- **é…ç½®**ï¼š

```csharp
if (app.Environment.IsDevelopment())
{
    app.UseDeveloperExceptionPage(); // åƒ…åœ¨é–‹ç™¼ç’°å¢ƒå•Ÿç”¨
}
```

- **å„ªé»**ï¼šæä¾›è±å¯Œçš„åµéŒ¯è³‡è¨Šã€‚
- **ç¼ºé»**ï¼š**çµ•å°ä¸èƒ½åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ä½¿ç”¨**ï¼Œå› ç‚ºå®ƒæœƒæš´éœ²æ•æ„Ÿçš„æ‡‰ç”¨ç¨‹å¼å…§éƒ¨ç´°ç¯€ã€‚

### 2. ç”Ÿç”¢ç’°å¢ƒï¼šç•°å¸¸è™•ç†ä¸­ä»‹è»Ÿé«” (`UseExceptionHandler`)

åœ¨ç”Ÿç”¢ç’°å¢ƒä¸­ï¼Œæ‚¨éœ€è¦å‘ä½¿ç”¨è€…é¡¯ç¤ºä¸€å€‹å‹å–„çš„éŒ¯èª¤é é¢ï¼Œè€Œä¸æ˜¯è©³ç´°çš„éŒ¯èª¤è³‡è¨Šã€‚åŒæ™‚ï¼Œæ‚¨ä¹Ÿéœ€è¦å°‡éŒ¯èª¤è¨˜éŒ„ä¸‹ä¾†ä¾›é–‹ç™¼è€…åˆ†æã€‚

- **é…ç½®**ï¼š

```csharp
else
{
    app.UseExceptionHandler("/Home/Error"); // å°‡æ‰€æœ‰æœªè™•ç†çš„ç•°å¸¸é‡å®šå‘åˆ° /Home/Error è·¯å¾‘
    app.UseHsts(); // å•Ÿç”¨ HSTS (HTTP Strict Transport Security)
}
```

- **`UseExceptionHandler(path)`**ï¼š
    - ç•¶ç®¡é“ä¸­ç™¼ç”Ÿæœªè™•ç†çš„ç•°å¸¸æ™‚ï¼Œå®ƒæœƒæ•ç²è©²ç•°å¸¸ï¼Œä¸¦å°‡è«‹æ±‚é‡å®šå‘åˆ°æ‚¨æŒ‡å®šçš„è·¯å¾‘ï¼ˆä¾‹å¦‚ `/Home/Error`ï¼‰ã€‚

    - åœ¨é‡å®šå‘çš„ Controller Action ä¸­ï¼Œæ‚¨å¯ä»¥è¨ªå•åˆ°ç•°å¸¸è³‡è¨Šï¼Œä»¥ä¾¿è¨˜éŒ„æ—¥èªŒæˆ–é¡¯ç¤ºçµ¦ä½¿ç”¨è€…ã€‚

- **éŒ¯èª¤ Controller Action ç¯„ä¾‹ (`HomeController.cs`)**ï¼š
```csharp
// Controllers/HomeController.cs
using Microsoft.AspNetCore.Diagnostics; // å¼•å…¥å‘½åç©ºé–“
using Microsoft.Extensions.Logging;

public class HomeController : Controller
{
    private readonly ILogger<HomeController> _logger;

    public HomeController(ILogger<HomeController> logger)
    {
        _logger = logger;
    }

    [ResponseCache(Duration = 0, Location = ResponseCacheLocation.None, NoStore = true)]
    public IActionResult Error()
    {
        // ç²å–ç•°å¸¸è³‡è¨Š
        var exceptionHandlerPathFeature = HttpContext.Features.Get<IExceptionHandlerPathFeature>();
        if (exceptionHandlerPathFeature != null)
        {
            // è¨˜éŒ„éŒ¯èª¤æ—¥èªŒ (åŒ…å«ç•°å¸¸å †ç–Šè¿½è¹¤)
            _logger.LogError(exceptionHandlerPathFeature.Error, "An unhandled exception occurred at {Path}", exceptionHandlerPathFeature.Path);

            // å°‡éŒ¯èª¤è³‡è¨Šå‚³éçµ¦ View (åªå‚³éå®‰å…¨ã€éæ•æ„Ÿè³‡è¨Š)
            ViewData["ErrorMessage"] = "å¾ˆæŠ±æ­‰ï¼Œæ‚¨çš„è«‹æ±‚ç™¼ç”Ÿäº†éŒ¯èª¤ã€‚è«‹ç¨å¾Œå†è©¦ã€‚";
            // å°æ–¼é–‹ç™¼è€…ï¼Œå¯ä»¥è€ƒæ…®åœ¨é–‹ç™¼ç’°å¢ƒä¸‹é¡¯ç¤ºæ›´å¤šç´°ç¯€ï¼Œä½†ç”Ÿç”¢ç’°å¢ƒä¸‹çµ•å°ä¸è¡Œ
            // if (HttpContext.RequestServices.GetRequiredService<IWebHostEnvironment>().IsDevelopment())
            // {
            //     ViewData["DetailedError"] = exceptionHandlerPathFeature.Error.Message;
            // }
        }
        return View();
    }
}
```

- **éŒ¯èª¤ View ç¯„ä¾‹ (`Error.cshtml`)**ï¼š

```html
@{
    ViewData["Title"] = "éŒ¯èª¤";
}

<h1 class="text-danger">éŒ¯èª¤ã€‚</h1>
<h2 class="text-danger">è™•ç†æ‚¨çš„è«‹æ±‚æ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚</h2>

@if (ViewData["ErrorMessage"] != null)
{
    <p>@ViewData["ErrorMessage"]</p>
}
@*
    å°æ–¼ç”Ÿç”¢ç’°å¢ƒï¼Œè«‹å‹¿é¡¯ç¤ºè©³ç´°çš„éŒ¯èª¤è³‡è¨Šã€‚
    åœ¨é–‹ç™¼ç’°å¢ƒä¸­ï¼Œæ‚¨å¯ä»¥è€ƒæ…®é¡¯ç¤º ViewData["DetailedError"] ä»¥ä¾¿åµéŒ¯ã€‚
*@
```

- **å„ªé»**ï¼šå®‰å…¨ï¼Œæä¾›å‹å–„çš„ä½¿ç”¨è€…é«”é©—ï¼Œä¸¦å…è¨±è¨˜éŒ„è©³ç´°çš„éŒ¯èª¤æ—¥èªŒã€‚
- **ç¼ºé»**ï¼šå°æ–¼æ¯å€‹è«‹æ±‚ï¼Œå³ä½¿æ²’æœ‰éŒ¯èª¤ï¼Œä¹Ÿæœƒæœ‰è¼•å¾®çš„æ€§èƒ½é–‹éŠ·ã€‚

### 3. è™•ç† HTTP ç‹€æ…‹ç¢¼éŒ¯èª¤ (`UseStatusCodePages`)

`UseExceptionHandler` è™•ç†çš„æ˜¯**æœªè™•ç†çš„ç•°å¸¸**ï¼Œè€Œ `UseStatusCodePages` å‰‡ç”¨æ–¼è™•ç†**éç•°å¸¸çš„ HTTP ç‹€æ…‹ç¢¼éŸ¿æ‡‰**ï¼Œä¾‹å¦‚ 404 (Not Found)ã€401 (Unauthorized)ã€403 (Forbidden) ç­‰ã€‚ç•¶ MVC Action è¿”å› `NotFound()` æˆ– `Unauthorized()` ç­‰çµæœæ™‚ï¼Œ`UseStatusCodePages` æœƒä»‹å…¥ã€‚

- **é…ç½®**ï¼š

```csharp
// Program.cs
// æ”¾åœ¨ UseExceptionHandler ä¹‹å¾Œï¼ŒUseRouting ä¹‹å‰
app.UseStatusCodePages(); // æœ€ç°¡å–®çš„é è¨­éŸ¿æ‡‰ (ç´”æ–‡å­—)
// æˆ–
app.UseStatusCodePagesWithReExecute("/Home/Error/{0}"); // é‡å®šå‘åˆ°æŒ‡å®šè·¯å¾‘ï¼Œ{0} æœƒè¢«æ›¿æ›ç‚ºç‹€æ…‹ç¢¼
// æˆ–
app.UseStatusCodePagesWithRedirects("/Home/Error?statusCode={0}"); // 302 é‡å®šå‘åˆ°æŒ‡å®šè·¯å¾‘
```

- **`UseStatusCodePages()`**ï¼š
    
    - ç•¶éŸ¿æ‡‰ç‹€æ…‹ç¢¼ç‚º 400-599 ä¸”éŸ¿æ‡‰é«”ç‚ºç©ºæ™‚ï¼Œæœƒç”Ÿæˆä¸€å€‹ç°¡å–®çš„æ–‡å­—éŸ¿æ‡‰ï¼ˆä¾‹å¦‚ "Status Code: 404; Not Found"ï¼‰ã€‚

- **`UseStatusCodePagesWithReExecute(pathFormat)`**ï¼š
    
    - é€™æ˜¯æœ€æ¨è–¦çš„æ–¹å¼ã€‚å®ƒæœƒ**é‡æ–°åŸ·è¡Œ**è«‹æ±‚ç®¡é“ï¼Œä½†ä½¿ç”¨æ–°çš„è·¯å¾‘ã€‚é€™æ„å‘³è‘—ç€è¦½å™¨çš„ URL ä¸æœƒæ”¹è®Šï¼Œä½†æ‡‰ç”¨ç¨‹å¼æœƒå…§éƒ¨è™•ç†åˆ°æŒ‡å®šçš„éŒ¯èª¤é é¢ã€‚
    
    - åœ¨ `Error` Action ä¸­ï¼Œæ‚¨å¯ä»¥é€é `IStatusCodeReExecuteFeature` ç²å–åŸå§‹è·¯å¾‘å’Œç‹€æ…‹ç¢¼ã€‚
    
    - **ç¯„ä¾‹ `HomeController.cs` (çµåˆ `UseStatusCodePagesWithReExecute`)**ï¼š
```csharp
public IActionResult Error(int? statusCode = null) // æ¥æ”¶ç‹€æ…‹ç¢¼
{
    if (statusCode.HasValue)
    {
        if (statusCode == 404)
        {
            _logger.LogWarning("404 Not Found: {Path}", HttpContext.Features.Get<IStatusCodeReExecuteFeature>()?.OriginalPath);
            ViewData["ErrorMessage"] = "å¾ˆæŠ±æ­‰ï¼Œæ‚¨è«‹æ±‚çš„é é¢ä¸å­˜åœ¨ã€‚";
        }
        else if (statusCode == 401)
        {
            _logger.LogWarning("401 Unauthorized: {Path}", HttpContext.Features.Get<IStatusCodeReExecuteFeature>()?.OriginalPath);
            ViewData["ErrorMessage"] = "æ‚¨æ²’æœ‰æ¬Šé™è¨ªå•æ­¤è³‡æºã€‚";
        }
        else if (statusCode == 500)
        {
            // 500 éŒ¯èª¤é€šå¸¸å·²ç¶“è¢« UseExceptionHandler è™•ç†ï¼Œé€™è£¡ä½œç‚ºå‚™ç”¨
            _logger.LogError("500 Internal Server Error: {Path}", HttpContext.Features.Get<IStatusCodeReExecuteFeature>()?.OriginalPath);
            ViewData["ErrorMessage"] = "å¾ˆæŠ±æ­‰ï¼Œä¼ºæœå™¨ç™¼ç”Ÿäº†å…§éƒ¨éŒ¯èª¤ã€‚";
        }
        else
        {
            _logger.LogError("Unhandled Status Code {StatusCode}: {Path}", statusCode, HttpContext.Features.Get<IStatusCodeReExecuteFeature>()?.OriginalPath);
            ViewData["ErrorMessage"] = $"ç™¼ç”Ÿäº†éŒ¯èª¤ï¼Œç‹€æ…‹ç¢¼ï¼š{statusCode}ã€‚";
        }
    }
    // è™•ç†ç”± UseExceptionHandler æ•ç²çš„ç•°å¸¸
    var exceptionHandlerPathFeature = HttpContext.Features.Get<IExceptionHandlerPathFeature>();
    if (exceptionHandlerPathFeature != null)
    {
        _logger.LogError(exceptionHandlerPathFeature.Error, "An unhandled exception occurred at {Path}", exceptionHandlerPathFeature.Path);
        ViewData["ErrorMessage"] = "å¾ˆæŠ±æ­‰ï¼Œæ‚¨çš„è«‹æ±‚ç™¼ç”Ÿäº†éŒ¯èª¤ã€‚è«‹ç¨å¾Œå†è©¦ã€‚";
    }

    return View();
}
```

- **`UseStatusCodePagesWithRedirects(pathFormat)`**ï¼š
    
    - ç™¼é€ä¸€å€‹ 302 é‡å®šå‘éŸ¿æ‡‰åˆ°æŒ‡å®šè·¯å¾‘ã€‚ç€è¦½å™¨çš„ URL æœƒæ”¹è®Šã€‚ä¸æ¨è–¦ç”¨æ–¼éŒ¯èª¤é é¢ï¼Œå› ç‚ºé€™æœƒå°è‡´é¡å¤–çš„ç¶²è·¯è«‹æ±‚å’Œ URL æ”¹è®Šã€‚

### 4. æ§åˆ¶å™¨å±¤ç´šçš„éŒ¯èª¤è™•ç† (Filter)

å°æ–¼ Controller Action å…§éƒ¨çš„ç‰¹å®šéŒ¯èª¤ï¼Œå¯ä»¥ä½¿ç”¨**ç•°å¸¸éæ¿¾å™¨ (Exception Filters)**ã€‚

- **å¯¦ç¾ `IExceptionFilter` æˆ–ç¹¼æ‰¿ `ExceptionFilterAttribute`**ï¼š

```csharp
// Filters/CustomExceptionFilter.cs
using Microsoft.AspNetCore.Mvc.Filters;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;

public class CustomExceptionFilter : ExceptionFilterAttribute
{
    private readonly ILogger<CustomExceptionFilter> _logger;

    public CustomExceptionFilter(ILogger<CustomExceptionFilter> logger)
    {
        _logger = logger;
    }

    public override void OnException(ExceptionContext context)
    {
        // è¨˜éŒ„ç•°å¸¸
        _logger.LogError(context.Exception, "Exception caught by CustomExceptionFilter: {Message}", context.Exception.Message);

        // è¨­å®šéŸ¿æ‡‰
        context.Result = new ViewResult { ViewName = "Error" }; // è¿”å›ä¸€å€‹éŒ¯èª¤é é¢
        // æˆ–è€… context.Result = new JsonResult(new { error = "An unexpected error occurred." }) { StatusCode = 500 }; // è¿”å› JSON éŒ¯èª¤
        context.ExceptionHandled = true; // æ¨™è¨˜ç‚ºå·²è™•ç†ï¼Œé˜²æ­¢ç•°å¸¸å†æ¬¡å‘ä¸Šæ‹‹å‡º
        base.OnException(context);
    }
}
```

**è¨»å†Šéæ¿¾å™¨**ï¼š

- **å…¨åŸŸè¨»å†Š**ï¼šåœ¨ `Program.cs` ä¸­è¨»å†Šåˆ° `AddControllersWithViews`ã€‚

```csharp
builder.Services.AddControllersWithViews(options =>
{
    options.Filters.Add(typeof(CustomExceptionFilter));
});
```

- **æ§åˆ¶å™¨æˆ– Action å±¤ç´šè¨»å†Š**ï¼š

```csharp
[ServiceFilter(typeof(CustomExceptionFilter))] // é€é DI æ³¨å…¥
// æˆ– [CustomExceptionFilter] å¦‚æœæ˜¯ç›´æ¥ç¹¼æ‰¿ ExceptionFilterAttribute ä¸”æœ‰é è¨­å»ºæ§‹å­
public class MyController : Controller
{
    // ...
}
```

- **å„ªé»**ï¼šå¯ä»¥é‡å°ç‰¹å®šæ§åˆ¶å™¨æˆ– Action é€²è¡ŒéŒ¯èª¤è™•ç†ï¼Œæä¾›æ›´ç´°ç²’åº¦çš„æ§åˆ¶ã€‚
- **ç¼ºé»**ï¼šåªèƒ½æ•ç² Controller Action åŸ·è¡Œéç¨‹ä¸­çš„ç•°å¸¸ï¼Œç„¡æ³•æ•ç²ä¸­ä»‹è»Ÿé«”ç®¡é“ä¸­æ›´æ—©ç™¼ç”Ÿçš„ç•°å¸¸ã€‚

### 5. `try-catch` å€å¡Š

å°æ–¼æ‚¨**é æœŸå¯èƒ½ç™¼ç”Ÿ**çš„éŒ¯èª¤ï¼ˆä¾‹å¦‚è³‡æ–™åº«æ“ä½œå¤±æ•—ã€å¤–éƒ¨ API èª¿ç”¨å¤±æ•—ï¼‰ï¼Œæ‡‰è©²åœ¨ç¨‹å¼ç¢¼ä¸­æ˜ç¢ºä½¿ç”¨ `try-catch` å€å¡Šä¾†æ•ç²å’Œè™•ç†ã€‚

```csharp
public async Task<IActionResult> GetProduct(int id)
{
    try
    {
        var product = await _productService.GetProductDetailsAsync(id);
        if (product == null)
        {
            return NotFound(); // è¿”å› 404 ç‹€æ…‹ç¢¼
        }
        return View(product);
    }
    catch (ArgumentException ex) // æ•ç²ç‰¹å®šç•°å¸¸
    {
        _logger.LogWarning(ex, "Invalid argument for GetProduct: {Id}", id);
        return BadRequest("ç„¡æ•ˆçš„ç”¢å“IDã€‚");
    }
    catch (Exception ex) // æ•ç²æ‰€æœ‰å…¶ä»–ç•°å¸¸
    {
        _logger.LogError(ex, "Error retrieving product {Id}", id);
        return StatusCode(500, "å…§éƒ¨ä¼ºæœå™¨éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
    }
}
```

- **å„ªé»**ï¼šç²¾ç¢ºæ§åˆ¶éŒ¯èª¤è™•ç†é‚è¼¯ï¼Œå¯ä»¥æä¾›æ›´å…·é«”çš„éŒ¯èª¤è¨Šæ¯ã€‚
- **ç¼ºé»**ï¼šéåº¦ä½¿ç”¨æœƒä½¿ç¨‹å¼ç¢¼è®Šå¾—å†—é•·ã€‚

---

## ğŸ’¡ è‡ªè¨‚ä¸­ä»‹è»Ÿé«”

é™¤äº† ASP.NET Core æä¾›çš„å…§å»ºä¸­ä»‹è»Ÿé«”ï¼Œæ‚¨é‚„å¯ä»¥å»ºç«‹è‡ªå·±çš„ä¸­ä»‹è»Ÿé«”ä¾†å¯¦ç¾ç‰¹å®šçš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š

- è«‹æ±‚/éŸ¿æ‡‰æ—¥èªŒ
- è‡ªè¨‚èº«ä»½é©—è­‰/æˆæ¬Šé‚è¼¯
- è«‹æ±‚é ­è™•ç†
- æµé‡é™åˆ¶
- çŸ­è·¯ç‰¹å®šè«‹æ±‚

### å»ºç«‹è‡ªè¨‚ä¸­ä»‹è»Ÿé«”çš„å…©ç¨®æ–¹å¼ï¼š

1. **åŸºæ–¼ç´„å®š (Convention-based) çš„ä¸­ä»‹è»Ÿé«”**ï¼š
    
    - éœ€è¦ä¸€å€‹å…¬å…±çš„ `InvokeAsync(HttpContext context, RequestDelegate next)` æ–¹æ³•ã€‚
    - å»ºæ§‹å­å¯ä»¥æ¥å—å…¶ä»–æœå‹™çš„ä¾è³´æ³¨å…¥ã€‚

```csharp
// Middleware/RequestLoggingMiddleware.cs
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;
using System.Threading.Tasks;

public class RequestLoggingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<RequestLoggingMiddleware> _logger;

    public RequestLoggingMiddleware(RequestDelegate next, ILogger<RequestLoggingMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        _logger.LogInformation("Request received: {Method} {Path}", context.Request.Method, context.Request.Path);

        // èª¿ç”¨ç®¡é“ä¸­çš„ä¸‹ä¸€å€‹ä¸­ä»‹è»Ÿé«”
        await _next(context);

        _logger.LogInformation("Response sent: {StatusCode}", context.Response.StatusCode);
    }
}
```

- **è¨»å†Š**ï¼šåœ¨ `Program.cs` ä¸­ä½¿ç”¨ `app.UseMiddleware<T>()`ã€‚

```csharp
app.UseMiddleware<RequestLoggingMiddleware>();
```

2. **åŸºæ–¼å·¥å»  (Factory-based) çš„ä¸­ä»‹è»Ÿé«”**ï¼š

- å¯¦ç¾ `IMiddleware` ä»‹é¢ã€‚
- å…è¨±åœ¨æ¯å€‹è«‹æ±‚ä¸­å‰µå»ºä¸­ä»‹è»Ÿé«”çš„æ–°å¯¦ä¾‹ï¼Œä¸¦å¯ä»¥é€é DI æ³¨å…¥æœå‹™ã€‚

```csharp
// Middleware/CustomHeaderMiddleware.cs
using Microsoft.AspNetCore.Http;
using System.Threading.Tasks;

public class CustomHeaderMiddleware : IMiddleware
{
    // å¯ä»¥åœ¨é€™è£¡æ³¨å…¥æœå‹™ï¼Œä¾‹å¦‚ IConfiguration
    public CustomHeaderMiddleware() { }

    public async Task InvokeAsync(HttpContext context, RequestDelegate next)
    {
        context.Response.Headers.Add("X-Custom-Header", "My App Value");
        await next(context);
    }
}
```

**è¨»å†Š**ï¼š
- é¦–å…ˆï¼Œå°‡ä¸­ä»‹è»Ÿé«”è¨»å†Šç‚ºæœå‹™ï¼š
```csharp
builder.Services.AddScoped<CustomHeaderMiddleware>(); // æˆ– AddTransient
```
- ç„¶å¾Œåœ¨ `Program.cs` ä¸­ä½¿ç”¨ `app.UseMiddleware<T>()`ï¼š
```csharp
app.UseMiddleware<CustomHeaderMiddleware>();
```

### ä¸­ä»‹è»Ÿé«”æ“´å±•æ–¹æ³•

ç‚ºäº†è®“ä¸­ä»‹è»Ÿé«”çš„ä½¿ç”¨æ›´ç°¡æ½”ï¼Œé€šå¸¸æœƒç‚ºå…¶å‰µå»ºä¸€å€‹æ“´å±•æ–¹æ³•ï¼š

```csharp
// Extensions/MiddlewareExtensions.cs
using Microsoft.AspNetCore.Builder;

public static class MiddlewareExtensions
{
    public static IApplicationBuilder UseRequestLogging(this IApplicationBuilder builder)
    {
        return builder.UseMiddleware<RequestLoggingMiddleware>();
    }

    public static IApplicationBuilder UseCustomHeader(this IApplicationBuilder builder)
    {
        return builder.UseMiddleware<CustomHeaderMiddleware>();
    }
}
```

- **ä½¿ç”¨**ï¼š
```csharp
app.UseRequestLogging();
app.UseCustomHeader();
```

---
## ç¸½çµèˆ‡å¯¦å‹™å»ºè­°

- **ç’°å¢ƒå€åˆ†**ï¼šæ°¸é æ ¹æ“š `ASPNETCORE_ENVIRONMENT` ä¾†å€åˆ†é–‹ç™¼å’Œç”Ÿç”¢ç’°å¢ƒçš„éŒ¯èª¤è™•ç†ç­–ç•¥ã€‚
- **æ—¥èªŒå„ªå…ˆ**ï¼šåœ¨æ•ç²ä»»ä½•éŒ¯èª¤æ™‚ï¼Œç¬¬ä¸€ä»¶äº‹å°±æ˜¯å°‡å…¶è©³ç´°è¨˜éŒ„ä¸‹ä¾†ã€‚
- **å‹å–„æç¤º**ï¼šå‘ä½¿ç”¨è€…é¡¯ç¤ºæ¸…æ™°ã€å‹å–„ä¸”ä¸æš´éœ²å…§éƒ¨ç´°ç¯€çš„éŒ¯èª¤è¨Šæ¯ã€‚
- **ç‹€æ…‹ç¢¼**ï¼šç¢ºä¿æ‚¨çš„æ‡‰ç”¨ç¨‹å¼è¿”å›æ­£ç¢ºçš„ HTTP ç‹€æ…‹ç¢¼ï¼Œé€™å°æ–¼ API æ¶ˆè²»è€…å’ŒåµéŒ¯è‡³é—œé‡è¦ã€‚
- **ä¸­ä»‹è»Ÿé«”é †åº**ï¼šéŒ¯èª¤è™•ç†ä¸­ä»‹è»Ÿé«”æ‡‰è©²åœ¨ç®¡é“çš„**æ—©æœŸ**é…ç½®ï¼Œä»¥ä¾¿æ•ç²å¾ŒçºŒä¸­ä»‹è»Ÿé«”ä¸­çš„ç•°å¸¸ã€‚
- **è‡ªè¨‚ä¸­ä»‹è»Ÿé«”**ï¼šç•¶éœ€è¦å°æ‰€æœ‰è«‹æ±‚é€²è¡Œçµ±ä¸€çš„æ©«åˆ‡é—œæ³¨é»è™•ç†æ™‚ï¼Œä¸­ä»‹è»Ÿé«”æ˜¯ç†æƒ³çš„é¸æ“‡ã€‚
- **Filter èˆ‡ Middleware çš„é¸æ“‡**ï¼š
    - **Middleware**ï¼šè™•ç†æ‰€æœ‰è«‹æ±‚ï¼Œä½æ–¼ç®¡é“çš„æ—©æœŸï¼Œé©ç”¨æ–¼å…¨åŸŸæ€§çš„ã€èˆ‡ HTTP è«‹æ±‚/éŸ¿æ‡‰ç”Ÿå‘½é€±æœŸç·Šå¯†ç›¸é—œçš„ä»»å‹™ï¼ˆå¦‚èº«ä»½é©—è­‰ã€æ—¥èªŒã€éŒ¯èª¤è™•ç†ï¼‰ã€‚
    - **Filter**ï¼šé‡å° MVC/API æ§åˆ¶å™¨å’Œ Actionï¼Œé©ç”¨æ–¼ Action åŸ·è¡Œå‰å¾Œçš„é‚è¼¯ï¼ˆå¦‚æ¨¡å‹é©—è­‰ã€æˆæ¬Šã€çµæœè™•ç†ã€Action ç´šåˆ¥çš„ç•°å¸¸è™•ç†ï¼‰ã€‚

---
## ğŸ”— ç›¸é—œå¡ç‰‡

- [[011.6-CoreMVC-ä¾è³´æ³¨å…¥èˆ‡æœå‹™è¨»å†Š]] (ä¸­ä»‹è»Ÿé«”å’Œéæ¿¾å™¨é€šå¸¸æœƒé€é DI ç²å–æœå‹™)
- [[011.9-CoreMVC-çµ„æ…‹ç®¡ç†èˆ‡ç’°å¢ƒè¨­å®š (Configuration)]] (éŒ¯èª¤é é¢è·¯å¾‘ã€æ—¥èªŒç´šåˆ¥ç­‰é…ç½®)
- [[011.11-CoreMVC-æ—¥èªŒè¨˜éŒ„èˆ‡ç›£æ§ (Logging)]] (éŒ¯èª¤è™•ç†é€šå¸¸ä¼´éš¨æ—¥èªŒè¨˜éŒ„)
- [[011.13-CoreMVC-å®‰å…¨æ€§èˆ‡æˆæ¬Š (Authentication & Authorization)]] (èº«ä»½é©—è­‰å’Œæˆæ¬Šä¹Ÿæ˜¯ä¸­ä»‹è»Ÿé«”)
- [[011.16-CoreMVC-éƒ¨ç½²èˆ‡ç¶­è­· (Deployment & Maintenance)]] (éŒ¯èª¤è™•ç†æ˜¯ç¶­è­·çš„é—œéµ)