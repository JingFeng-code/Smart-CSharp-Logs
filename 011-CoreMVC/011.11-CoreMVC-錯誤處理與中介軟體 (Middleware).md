---
title: 🚨 011.9-CoreMVC-錯誤處理與中介軟體 (Middleware)
tags:
  - ASP-NET
  - Core
  - MVC
  - 錯誤處理
  - Middleware
  - 例外管理
aliases:
  - CoreMVC 錯誤處理
  - ASP.NET Core Middleware
created: 2025-07-02
updated: 2025-07-02
status: 草稿
summary: 介紹 ASP.NET Core MVC 的錯誤處理機制、例外攔截、常見中介軟體（Middleware）設計與實務應用，協助提升系統穩定性與可維護性。
---

## 🚨 錯誤處理（Error Handling）概述

- ASP.NET Core 提供多層次錯誤處理方式，確保應用程式在發生例外時能妥善回應並記錄問題。
- 常見處理層級：
  - 全域錯誤處理（Middleware）
  - Controller/Action 層級 try-catch
  - ModelState 驗證錯誤

---
## 🛠️ 全域錯誤處理與 Middleware

- **中介軟體（Middleware）** 可攔截所有請求與回應，適合統一處理例外、記錄日誌、回傳自訂錯誤頁面或 JSON。

### 1. 使用 Developer Exception Page（開發環境）

```csharp
if (app.Environment.IsDevelopment())  
{  
	app.UseDeveloperExceptionPage();  
}  
else  
{  
	app.UseExceptionHandler("/Home/Error"); // 自訂錯誤頁面  
	app.UseHsts();  
}
```

### 2. 自訂全域錯誤 Middleware

```csharp
public class ErrorHandlingMiddleware  
{  
	private readonly RequestDelegate _next;  
	private readonly ILogger<ErrorHandlingMiddleware> _logger;
	public ErrorHandlingMiddleware(RequestDelegate next, ILogger<ErrorHandlingMiddleware> logger)
	{
	    _next = next;
	    _logger = logger;
	}

	public async Task Invoke(HttpContext context)
	{
	    try
	    {
	        await _next(context);
	    }
	    catch (Exception ex)
	    {
	        _logger.LogError(ex, "Unhandled exception");
	        context.Response.StatusCode = 500;
	        await context.Response.WriteAsync("發生系統錯誤，請稍後再試。");
	    }
	}
}

// 在 Program.cs 註冊
app.UseMiddleware<ErrorHandlingMiddleware>();

```

---
## 📝 Controller/Action 層級錯誤處理

- 可於特定 Action 以 try-catch 處理預期例外，回傳自訂訊息或錯誤頁面。

```csharp
public IActionResult Details(int id)  
{  
	try  
	{  
		var item = _service.GetItem(id);  
		if (item == null) return NotFound();  
		return View(item);  
	}  
	catch (Exception ex)  
	{  
		_logger.LogError(ex, "取得資料失敗");  
		return View("Error");  
	}  
}
```

---
## ⚠️ ModelState 驗證錯誤

- 表單送出時，ModelState 驗證失敗可回傳原頁面並顯示錯誤訊息，屬於業務層級的錯誤處理。

---
## 🧩 常見中介軟體（Middleware）應用

- **日誌記錄**（Logging）：統一記錄請求、錯誤、效能資料。
- **權限驗證**（Authentication/Authorization）：檢查用戶身分與權限。
- **跨域處理**（CORS）：允許或限制跨來源請求。
- **靜態檔案服務**：處理 wwwroot 靜態資源。
- **請求追蹤**：加入 RequestId、CorrelationId 追蹤請求流程。
- **自訂 Middleware**：如流量限制、API 版本控管等。

---
## 🛡️ 實務建議

- **開發環境與正式環境錯誤處理分離**，避免將詳細例外資訊暴露給用戶。
- **統一日誌與例外管理**，方便後續問題追蹤與維護。
- **善用中介軟體順序**，確保錯誤處理在適當階段執行。
- **自訂錯誤頁面與 JSON 回應**，提升用戶體驗與 API 一致性。

---

## 🔗 相關卡片

- [[011.8-CoreMVC-分層架構與專案實務設計]]
- [[011.12-CoreMVC-安全性與授權 (Authentication & Authorization)]]
- [[011.13-CoreMVC-效能優化與快取]]
