---
title: ğŸš¨ 011.9-CoreMVC-éŒ¯èª¤è™•ç†èˆ‡ä¸­ä»‹è»Ÿé«” (Middleware)
tags:
  - ASP-NET
  - Core
  - MVC
  - éŒ¯èª¤è™•ç†
  - Middleware
  - ä¾‹å¤–ç®¡ç†
aliases:
  - CoreMVC éŒ¯èª¤è™•ç†
  - ASP.NET Core Middleware
created: 2025-07-02
updated: 2025-07-02
status: è‰ç¨¿
summary: ä»‹ç´¹ ASP.NET Core MVC çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ã€ä¾‹å¤–æ””æˆªã€å¸¸è¦‹ä¸­ä»‹è»Ÿé«”ï¼ˆMiddlewareï¼‰è¨­è¨ˆèˆ‡å¯¦å‹™æ‡‰ç”¨ï¼Œå”åŠ©æå‡ç³»çµ±ç©©å®šæ€§èˆ‡å¯ç¶­è­·æ€§ã€‚
---

## ğŸš¨ éŒ¯èª¤è™•ç†ï¼ˆError Handlingï¼‰æ¦‚è¿°

- ASP.NET Core æä¾›å¤šå±¤æ¬¡éŒ¯èª¤è™•ç†æ–¹å¼ï¼Œç¢ºä¿æ‡‰ç”¨ç¨‹å¼åœ¨ç™¼ç”Ÿä¾‹å¤–æ™‚èƒ½å¦¥å–„å›æ‡‰ä¸¦è¨˜éŒ„å•é¡Œã€‚
- å¸¸è¦‹è™•ç†å±¤ç´šï¼š
  - å…¨åŸŸéŒ¯èª¤è™•ç†ï¼ˆMiddlewareï¼‰
  - Controller/Action å±¤ç´š try-catch
  - ModelState é©—è­‰éŒ¯èª¤

---
## ğŸ› ï¸ å…¨åŸŸéŒ¯èª¤è™•ç†èˆ‡ Middleware

- **ä¸­ä»‹è»Ÿé«”ï¼ˆMiddlewareï¼‰** å¯æ””æˆªæ‰€æœ‰è«‹æ±‚èˆ‡å›æ‡‰ï¼Œé©åˆçµ±ä¸€è™•ç†ä¾‹å¤–ã€è¨˜éŒ„æ—¥èªŒã€å›å‚³è‡ªè¨‚éŒ¯èª¤é é¢æˆ– JSONã€‚

### 1. ä½¿ç”¨ Developer Exception Pageï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰

```csharp
if (app.Environment.IsDevelopment())  
{  
	app.UseDeveloperExceptionPage();  
}  
else  
{  
	app.UseExceptionHandler("/Home/Error"); // è‡ªè¨‚éŒ¯èª¤é é¢  
	app.UseHsts();  
}
```

### 2. è‡ªè¨‚å…¨åŸŸéŒ¯èª¤ Middleware

```csharp
public class ErrorHandlingMiddleware  
{  
	private readonly RequestDelegate _next;  
	private readonly ILogger<ErrorHandlingMiddleware>Â _logger;
	public ErrorHandlingMiddleware(RequestDelegate next, ILogger<ErrorHandlingMiddleware> logger)
	{
	    _next = next;
	    _logger = logger;
	}

	public async Task Invoke(HttpContext context)
	{
	    try
	    {
	        await _next(context);
	    }
	    catch (Exception ex)
	    {
	        _logger.LogError(ex, "Unhandled exception");
	        context.Response.StatusCode = 500;
	        await context.Response.WriteAsync("ç™¼ç”Ÿç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
	    }
	}
}

// åœ¨ Program.cs è¨»å†Š
app.UseMiddleware<ErrorHandlingMiddleware>();

```

---
## ğŸ“ Controller/Action å±¤ç´šéŒ¯èª¤è™•ç†

- å¯æ–¼ç‰¹å®š Action ä»¥ try-catch è™•ç†é æœŸä¾‹å¤–ï¼Œå›å‚³è‡ªè¨‚è¨Šæ¯æˆ–éŒ¯èª¤é é¢ã€‚

```csharp
public IActionResult Details(int id)  
{  
	try  
	{  
		var item = _service.GetItem(id);  
		if (item == null) return NotFound();  
		return View(item);  
	}  
	catch (Exception ex)  
	{  
		_logger.LogError(ex, "å–å¾—è³‡æ–™å¤±æ•—");  
		return View("Error");  
	}  
}
```

---
## âš ï¸ ModelState é©—è­‰éŒ¯èª¤

- è¡¨å–®é€å‡ºæ™‚ï¼ŒModelState é©—è­‰å¤±æ•—å¯å›å‚³åŸé é¢ä¸¦é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œå±¬æ–¼æ¥­å‹™å±¤ç´šçš„éŒ¯èª¤è™•ç†ã€‚

---
## ğŸ§© å¸¸è¦‹ä¸­ä»‹è»Ÿé«”ï¼ˆMiddlewareï¼‰æ‡‰ç”¨

- **æ—¥èªŒè¨˜éŒ„**ï¼ˆLoggingï¼‰ï¼šçµ±ä¸€è¨˜éŒ„è«‹æ±‚ã€éŒ¯èª¤ã€æ•ˆèƒ½è³‡æ–™ã€‚
- **æ¬Šé™é©—è­‰**ï¼ˆAuthentication/Authorizationï¼‰ï¼šæª¢æŸ¥ç”¨æˆ¶èº«åˆ†èˆ‡æ¬Šé™ã€‚
- **è·¨åŸŸè™•ç†**ï¼ˆCORSï¼‰ï¼šå…è¨±æˆ–é™åˆ¶è·¨ä¾†æºè«‹æ±‚ã€‚
- **éœæ…‹æª”æ¡ˆæœå‹™**ï¼šè™•ç† wwwroot éœæ…‹è³‡æºã€‚
- **è«‹æ±‚è¿½è¹¤**ï¼šåŠ å…¥ RequestIdã€CorrelationId è¿½è¹¤è«‹æ±‚æµç¨‹ã€‚
- **è‡ªè¨‚ Middleware**ï¼šå¦‚æµé‡é™åˆ¶ã€API ç‰ˆæœ¬æ§ç®¡ç­‰ã€‚

---
## ğŸ›¡ï¸ å¯¦å‹™å»ºè­°

- **é–‹ç™¼ç’°å¢ƒèˆ‡æ­£å¼ç’°å¢ƒéŒ¯èª¤è™•ç†åˆ†é›¢**ï¼Œé¿å…å°‡è©³ç´°ä¾‹å¤–è³‡è¨Šæš´éœ²çµ¦ç”¨æˆ¶ã€‚
- **çµ±ä¸€æ—¥èªŒèˆ‡ä¾‹å¤–ç®¡ç†**ï¼Œæ–¹ä¾¿å¾ŒçºŒå•é¡Œè¿½è¹¤èˆ‡ç¶­è­·ã€‚
- **å–„ç”¨ä¸­ä»‹è»Ÿé«”é †åº**ï¼Œç¢ºä¿éŒ¯èª¤è™•ç†åœ¨é©ç•¶éšæ®µåŸ·è¡Œã€‚
- **è‡ªè¨‚éŒ¯èª¤é é¢èˆ‡ JSON å›æ‡‰**ï¼Œæå‡ç”¨æˆ¶é«”é©—èˆ‡ API ä¸€è‡´æ€§ã€‚

---

## ğŸ”— ç›¸é—œå¡ç‰‡

- [[011.8-CoreMVC-åˆ†å±¤æ¶æ§‹èˆ‡å°ˆæ¡ˆå¯¦å‹™è¨­è¨ˆ]]
- [[011.12-CoreMVC-å®‰å…¨æ€§èˆ‡æˆæ¬Š (Authentication & Authorization)]]
- [[011.13-CoreMVC-æ•ˆèƒ½å„ªåŒ–èˆ‡å¿«å–]]
