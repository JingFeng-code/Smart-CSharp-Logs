---
title: 🧪 011.12-CoreMVC-單元測試與自動化
tags:
  - ASP.NET Core
  - MVC
  - 單元測試
  - 自動化測試
  - 測試驅動開發
aliases:
  - CoreMVC 單元測試
  - ASP.NET Core 測試自動化
created: 2025-07-02
updated: 2025-07-02
status: 草稿
summary: 介紹 ASP.NET Core MVC 的單元測試與自動化原則，涵蓋測試架構、Mock 技巧、測試實作範例、CI/CD 整合與最佳實務，協助提升系統品質與可維護性。
---

## 🧪 單元測試基本概念

- **單元測試（Unit Test）**：針對程式最小可測單元（如方法、類別）進行驗證，確保邏輯正確。
- **自動化測試**：利用工具自動執行測試，減少人為疏漏，提升開發效率與信心。
- **測試金字塔**：單元測試 > 整合測試 > UI/端對端測試，單元測試數量應最多。

---

## 🛠️ ASP.NET Core MVC 測試架構

- 常用測試框架：**xUnit.net**、NUnit、MSTest
- Mock 工具：**Moq**、NSubstitute
- 專案建議：主程式與測試專案分開，測試專案獨立安裝測試與 Mock 套件。

### 測試專案建立與安裝

```text
dotnet new xunit -n MyApp.Tests  
dotnet add package Moq  
dotnet add package Microsoft.AspNetCore.Mvc.Testing
```

---
## 🔄 依賴注入與 Mock 技巧

- **依賴注入（DI）** 讓 Controller/Service 可注入介面，單元測試時以 Mock 取代實際服務。
- **Moq 範例**：
```csharp
var mockService = new Mock<IProductService>();  
mockService.Setup(s => s.GetAll()).Returns(new List<Product> { ... });

var controller = new ProductController(mockService.Object);
```

- 測試時可模擬回傳資料、丟出例外等情境。

---
## 📝 單元測試範例（Controller）

```csharp
public class ProductControllerTests  
{  
	private readonly Mock<IProductService> _serviceMock;  
	private readonly ProductController _controller;
	public ProductControllerTests()
	{
	    _serviceMock = new Mock<IProductService>();
	    _controller = new ProductController(_serviceMock.Object);
	}

	[Fact]
	public void Index_ReturnsViewWithProducts()
	{
	    // Arrange
	    var products = new List<Product> { new Product { Id = 1, Name = "A" } };
	    _serviceMock.Setup(s => s.GetAll()).Returns(products);

	    // Act
	    var result = _controller.Index() as ViewResult;

	    // Assert
	    Assert.NotNull(result);
	    Assert.Equal(products, result.Model);
	}
}
```

---
## 🧩 進階測試工具與技巧

- **MyTested.AspNetCore.Mvc**：提供流暢語法，支援 Controller、Routing、驗證、授權等測試。
- **TestHost**：可模擬完整 HTTP 請求流程，進行整合測試與 API 測試。
- **自動化 UI 測試**：可用 Selenium、Playwright、Puppeteer 等工具模擬瀏覽器操作。

---
## 🏆 單元測試最佳實務

- **避免基礎設施依賴**：單元測試不應依賴資料庫、檔案、網路等外部資源。
- **明確命名**：測試方法命名應包含「被測方法_情境_預期結果」，提升可讀性。
- **覆蓋正向與負向案例**：測試正常流程、例外與邊界情境。
- **Mock 外部依賴**：利用 Mock 工具模擬服務、API、資料存取等。
- **持續重構與覆蓋率檢查**：定期檢查測試覆蓋率，確保關鍵邏輯皆有測試。

---
## 🔄 自動化測試與 CI/CD 整合

- 將測試整合至 CI/CD 流程（如 GitHub Actions、Azure DevOps、GitLab CI），每次提交自動執行測試。
- 測試失敗時自動阻擋佈署，確保品質。

---
## ⚠️ 常見問題與建議

- **測試過於依賴實作細節**：應聚焦於行為驗證，避免脆弱測試。
- **未 Mock 依賴服務**：導致測試慢且不穩定，應 Mock 所有外部依賴。
- **測試命名混亂**：難以維護與理解，建議統一命名規則。
- **只測正向案例**：需覆蓋例外、邊界與失敗情境。

---
## 🔍 延伸學習資源

- [Microsoft Learn：.NET 單元測試最佳實務][1][6]
- [Pluralsight：ASP.NET Core MVC Testing Fundamentals][2]
- [C# Corner：Unit Test in ASP.NET Core Application][3]
- [MyTested.AspNetCore.Mvc 官方文件][4]
- [Testing of ASP.NET Core MVC apps using Microsoft Test Host][5]
- [Unit Testing ASP.NET MVC with Web API Best Practices][8]

---
## 🔗 相關卡片

- [[011.11-CoreMVC-效能優化與快取]]
- [[011.13-CoreMVC-部署與維運]]
- [[011.8-CoreMVC-分層架構與專案實務設計]]





