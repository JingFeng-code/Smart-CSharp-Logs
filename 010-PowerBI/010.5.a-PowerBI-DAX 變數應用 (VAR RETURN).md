---
title: 🧮 010.5.a-PowerBI-DAX 變數應用 (VAR RETURN)
tags:
  - PowerBI
  - DAX
  - 變數
  - 資料分析
aliases:
  - DAX VAR
  - DAX RETURN
  - DAX 變數
created: 2025-07-08
updated: 2025-07-08
status: 完成
summary: 深入探討 Power BI DAX 中 VAR 和 RETURN 關鍵字的應用，包括其優勢、基本語法及多種實用範例，以提升 DAX 公式的可讀性、效能與可維護性。
---

## 🧮 DAX 變數的應用：讓公式更聰明、更易讀！

在 DAX 中，**`VAR` (Variable)** 和 **`RETURN`** 這對組合就像是 DAX 公式的「幕後魔法師」。它允許在一個 DAX 公式內部定義一個或多個臨時的命名變數，用於儲存中間計算的結果。最後，再用 `RETURN` 關鍵字指定公式要回傳的最終結果。

這就像在解一道複雜的數學題時，你不會把所有步驟都寫在一行，而是會分步驟計算出中間結果，然後再用這些中間結果得出最終答案。

### 為什麼要使用變數？

使用變數為 DAX 公式帶來多重效益：

1.  **提升可讀性 (Readability)**：
    將複雜的計算拆解為邏輯清晰、有意義的步驟，每個步驟都有一個明確的名稱。這使得公式更容易被理解，尤其是在處理嵌套多層函數或複雜邏輯時。

2.  **提升效能 (Performance)**：
    **變數只會被計算一次。** 如果一個中間計算結果在公式中被多次引用，使用變數可以避免重複執行相同的計算，從而顯著提升公式的執行效率。這在處理大型數據集或複雜報表時尤其關鍵。

3.  **簡化修改與偵錯 (Maintainability & Debugging)**：
    未來需要調整某個中間計算的邏輯時，只需修改變數的定義，而不需要在公式的多處重複修改。同時，在撰寫或檢查公式時，可以更容易地驗證每個變數的值，協助快速定位問題。

### 基本語法

DAX 變數的語法結構如下：

```dex
VAR <變數名稱1> = <表達式1>
VAR <變數名稱2> = <表達式2>
...
RETURN <最終回傳的表達式>
```

- **`VAR` 關鍵字**：後接變數的名稱，接著是等號 `=` 和變數所代表的**表達式 (Expression)**。這個表達式可以是任何有效的 DAX 公式，例如一個簡單的聚合、一個篩選過的計算，甚至是一個表格。
- **`RETURN` 關鍵字**：所有的 `VAR` 宣告都必須放在 `RETURN` 關鍵字之前。`RETURN` 關鍵字後面的表達式就是整個 DAX 公式最終回傳的結果。

---
## 🛠️ 變數的應用範例

現在透過幾個實際的例子，來看看 `VAR` 和 `RETURN` 如何讓 DAX 公式變得更強大和易懂：

### 範例 1：計算銷售成長率

此範例清晰地展示了如何分解複雜的時間智能計算。

```dex
銷售成長率 =
VAR 今年總銷售 = [總銷售額] // 將 [總銷售額] 這個度量值的值存入變數
VAR 去年同期銷售 = CALCULATE(
    [總銷售額],
    SAMEPERIODLASTYEAR('日期表'[日期])
) // 計算去年同期銷售額並存入變數

RETURN
    DIVIDE(
        今年總銷售 - 去年同期銷售, // 使用變數進行減法
        去年同期銷售,               // 使用變數作為除數
        0                           // 如果除數為零，返回 0
    )
```

### 範例 2：動態分類產品並計數 (結合篩選與表值函數)

這個範例展示了變數如何儲存**表格 (Table)** 和**標量 (Scalar)** 值，並進行後續的篩選。

```dex
高價值產品數量 =
VAR 所有產品銷售 =
    SUMMARIZE( // 建立一個包含每個產品及其總銷售額的臨時表
        '銷售明細',
        '銷售明細'[產品ID], // 以產品ID分組
        "產品總銷售", SUM('銷售明細'[金額]) // 計算每個產品的總銷售
    )
VAR 高價值閾值 = 50000 // 定義高價值產品的銷售閾值
VAR 高價值產品列表 =
    FILTER( // 從臨時表中篩選出銷售額超過閾值的產品
        所有產品銷售,
        [產品總銷售] >= 高價值閾值
    )
RETURN
    COUNTROWS(高價值產品列表) // 計算高價值產品的數量
```

- **變數型別**：`所有產品銷售` 變數儲存了一個計算出來的**表格**。`高價值閾值` 變數儲存了一個**標量值**。`高價值產品列表` 變數則再次基於前一個變數（表格）進行篩選，產生另一個**表格**。

- **效益**：此類公式若沒有變數，會因多層嵌套 `SUMMARIZE` 和 `FILTER` 而變得極其複雜，難以撰寫和理解。

### 範例 3：基於不同條件的複雜計算 (避免重複計算)

此範例展示了變數如何避免重複計算，並使條件判斷更清晰。

```dex
總佣金 =
VAR 總銷售額 = SUM('銷售表'[金額]) // 計算總銷售額，儲存一次
VAR 佣金率 =
    SWITCH(
        TRUE(), // 使用 TRUE() 模式實現多個條件判斷
        總銷售額 > 1000000, 0.05, // 如果總銷售額超過 1 百萬，佣金 5%
        總銷售額 > 500000, 0.03,  // 如果總銷售額超過 50 萬，佣金 3%
        總銷售額 > 100000, 0.01,  // 如果總銷售額超過 10 萬，佣金 1%
        0.00                      // 其他情況為 0%
    )
RETURN
    總銷售額 * 佣金率 // 使用已計算的總銷售額和佣金率
```

- **效能優化**：`總銷售額` 變數只被計算一次，隨後在 `SWITCH` 函數中被多次引用，並在最終的 `RETURN` 中再次引用。這避免了重複執行 `SUM('銷售表'[金額])`。

- **清晰度**：清晰地將「總銷售額」和「佣金率」這兩個獨立概念分開定義，使得佣金計算邏輯非常透明。

---
## ⚠️ 變數使用的注意事項

- **變數的作用域 (Scope)**：變數只在其定義的 DAX 公式內部有效。它不能在公式外部被引用。

- **變數的型別**：變數可以儲存**標量值**（單一值）、**表格**、或對**度量值**的引用。

- **單次評估**：DAX 變數的表達式會在定義它們的地方被「立即評估」一次，其結果會被快取。這正是它提升效能的關鍵，因為即使在 `RETURN` 區塊中被多次引用，它也不會被重複計算。

- **命名慣例**：給變數一個清晰、有意義的名稱，有助於大幅提升公式的可讀性和協作效率。

變數是 DAX 學習曲線中一個重要的里程碑。掌握了它的應用，就能更好地組織、優化和偵錯複雜的 DAX 公式，讓資料分析工作事半功倍！

---
## 🔗 相關卡片

- [[010.5-PowerBI-DAX 基礎語法]]
- [[010.6-PowerBI-互動功能與篩選器]] (變數在篩選上下文中的應用)
- [[010.9-PowerBI-DAX 進階計算與上下文轉換]] (深入了解變數與上下文的互動)