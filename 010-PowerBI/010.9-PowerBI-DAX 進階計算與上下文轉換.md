---
title: 🧮 010.9-PowerBI-DAX 進階計算與上下文轉換
tags:
  - PowerBI
  - DAX
  - 資料分析
  - BI工具
  - 上下文轉換
aliases:
  - DAX 上下文
  - DAX 進階
  - Filter Context
  - Row Context
created: 2025-07-08
updated: 2025-07-08
status: 完成
summary: 深入探討 DAX 中最核心的「上下文」概念，包括篩選上下文、行上下文及其互動，並重點解析 CALCULATE 函數如何改變上下文，是實現 DAX 進階計算的關鍵。
---

## 🧮 DAX 的「上下文」：理解 DAX 運算的秘密

在 DAX 中，所有的計算都不是孤立的，它們總是在特定的「**上下文 (Context)**」中進行。理解上下文是掌握 DAX 進階計算的基石，也是許多人學習 DAX 時感到困惑的關鍵點。

想像一個數學問題：計算「班級的平均分數」。這個問題會因為「誰是班級」、「哪些分數有效」而有不同的答案。DAX 的上下文，就是定義了這些「誰」和「哪些」：

1.  **行上下文 (Row Context)**：
    * **定義**：指 DAX 公式在**逐行**評估時所處的環境。當公式在表格的每一行上運算時，公式可以「看到」當前行的所有欄位值。
    * **發生時機**：
        * **計算欄位 (Calculated Column)**：當創建一個計算欄位時，DAX 會逐行遍歷該表格，並在每一行建立一個行上下文來計算該行的值。
        * **迭代函數 (Iterator Functions)**：所有帶 `X` 的 DAX 函數（如 `SUMX`, `AVERAGEX`, `COUNTX` 等），它們會逐行遍歷一個表格，並在每一行建立行上下文來評估其表達式。
    * **特性**：行上下文是「隱式」的，通常無法直接被報表的視覺化元素影響。

    **範例：計算欄位 `訂單總價`**
    ```dax
    訂單總價 = '訂單明細'[數量] * '訂單明細'[單價]
    ```
    當計算 `訂單總價` 時，DAX 會逐行遍歷 `訂單明細` 表。對於每一行，它都會進入一個行上下文，並找到該行的 `數量` 和 `單價` 進行乘法運算。

2.  **篩選上下文 (Filter Context)**：
    * **定義**：指 DAX 公式在執行時所應用的一組**篩選條件**。這些篩選條件決定了資料模型中「可見」的數據子集。只有符合這些篩選條件的數據才會參與計算。
    * **發生時機**：
        * **報表視覺化元素**：例如矩陣、表格、圖表，它們會對其顯示的數據施加篩選。
        * **切片器 (Slicers)**：用戶在切片器中選擇的值會作為篩選上下文。
        * **篩選窗格 (Filter Pane)**：手動在篩選器中添加的條件。
        * **交叉篩選 (Cross-filtering)**：一個視覺化元素篩選另一個視覺化元素。
        * **DAX 公式內部**：最重要的是透過 `CALCULATE` 函數來修改篩選上下文。
    * **特性**：篩選上下文是「顯式」的，它直接影響了計算結果的範圍。

    **範例：報表中的度量值 `總銷售額`**
    ```dax
    總銷售額 = SUM('銷售表'[金額])
    ```
    如果將 `總銷售額` 放在一個依據「年份」或「產品類別」篩選的報表中，`總銷售額` 會自動根據當前的篩選上下文（例如「2024 年」或「電子產品」）來計算。

### 行上下文與篩選上下文的互動

這兩種上下文並非獨立存在，它們會相互影響。尤其是在迭代函數（如 `SUMX`）內部，行上下文和外部的篩選上下文會同時起作用。

例如：`SUMX('訂單明細', '訂單明細'[數量] * '訂單明細'[單價])`
* `SUMX` 會先建立一個**行上下文**，逐行遍歷 `訂單明細` 表。
* 同時，這個計算仍然會受到**外部篩選上下文**的影響（例如，如果報表篩選了「2024 年的訂單」，那麼 `SUMX` 只會遍歷 2024 年的訂單）。

---

### **💡 後設認知思考：**
想像一個 Power BI 報表，你放置了一個表格視覺效果，其中包含「產品類別」和一個度量值「總銷售額」。當用戶點擊某個產品類別時，「總銷售額」的數字會自動變化。這是哪一種上下文在起作用？它是如何影響計算的？

---
## 🔑 `CALCULATE`：DAX 最強大的函數 (篩選上下文轉換)

`CALCULATE` 函數是 DAX 的核心，被譽為「DAX 引擎的開關」。它唯一的目的就是**改變篩選上下文 (Modify Filter Context)**，從而影響其內部表達式的評估結果。

### `CALCULATE` 的語法

```dax
CALCULATE(<表達式>, <篩選1>, <篩選2>, ...)
```

- `<表達式>`：這是要在修改後的篩選上下文下評估的任何 DAX 表達式，通常是一個聚合函數（如 `SUM`, `COUNTROWS`）。
    
- `<篩選>`：一個或多個篩選器，它們會：
    - **覆蓋 (Override)** 相同欄位上的現有篩選。
    - **新增 (Add)** 相同表格或相關表格上的新篩選。
    - **移除 (Remove)** 篩選 (透過 `ALL`, `ALLEXCEPT`, `REMOVEFILTERS` 等函數)。

### `CALCULATE` 如何改變篩選上下文？

`CALCULATE` 的篩選引數有兩種主要行為：

1. **添加或修改篩選 (Adding or Modifying Filters)**：
    - 當篩選引數指定一個新的篩選條件時，它會被添加到當前的篩選上下文。
    - 如果該篩選條件已經存在於當前的篩選上下文，那麼 `CALCULATE` 的篩選會**覆蓋**原有的篩選。
    
    **範例：計算特定地區的銷售額**
    `北美銷售額 = CALCULATE([總銷售額], '地區表'[地區] = "北美洲")`
    
    無論報表視覺效果如何篩選，這個度量值永遠只計算「北美洲」地區的總銷售額。如果視覺效果已經篩選了「歐洲」，那麼 `CALCULATE` 會無視「歐洲」的篩選，強制改為「北美洲」進行計算。

2. **移除篩選 (Removing Filters)**：

- 透過 `ALL` 或 `REMOVEFILTERS` 等函數，可以在 `CALCULATE` 內部暫時性地移除部分或所有篩選。

**範例：計算總銷售額佔比**

```dex
佔總銷售額百分比 =
DIVIDE(
    [總銷售額], // 當前篩選上下文下的總銷售額
    CALCULATE(
        [總銷售額],
        ALL('產品表') // 移除 '產品表' 上的所有篩選，即計算所有產品的總銷售額
    )
)
```

當這個度量值放在一個按「產品類別」顯示的表格中時，`[總銷售額]` 會顯示每個類別的銷售額，而 `CALCULATE([總銷售額], ALL('產品表'))` 則始終顯示所有產品的總銷售額，從而正確計算每個類別的佔比。

### 上下文轉換 (Context Transition)

**上下文轉換**是 `CALCULATE` 函數的一個特殊且重要的行為。它發生在**行上下文轉變為篩選上下文**的時候。

當 `CALCULATE` 函數在一個**行上下文**中被評估時（例如在迭代函數 `SUMX` 內部，或者在計算欄位中），`CALCULATE` 會自動將該**行上下文中的所有篩選**（即當前行的欄位值）轉換為**篩選上下文**。

**範例：計算「每筆訂單的總銷售額」 (使用 `SUMX` 和 `CALCULATE`)**

假設 `銷售表` 有 `訂單ID` 和 `金額` 欄位。我們想計算每筆訂單的總金額。 如果直接寫 `SUM('銷售表'[金額])` 作為計算欄位，它會在每個行上下文下計算整個 `銷售表` 的總和，這是錯誤的。 正確的做法是：

```dex
訂單總銷售額 =
SUMX(
    '銷售表', // 這是迭代器，為每一行建立行上下文
    CALCULATE( // 在每個行上下文內部，觸發上下文轉換
        '銷售表'[金額] // 要聚合的表達式
    )
)
```

或者更常見且推薦的寫法：

```dex
訂單總銷售額 = SUMX('銷售表', '銷售表'[金額])
```

當 `SUMX` 迭代 `銷售表` 的每一行時，它會為每一行創建一個**行上下文**。在每個行上下文內部，當 `銷售表'[金額]` 被評估時，**隱式地觸發了上下文轉換**。DAX 會將當前行的 `訂單ID` 作為一個篩選條件應用到篩選上下文中，使得 `'銷售表'[金額]` 只計算當前 `訂單ID` 下的金額。

**為什麼 `CALCULATE` 在這裡很重要？** 雖然上面的例子，`SUMX('銷售表', '銷售表'[金額])` 也能達成目標，但當表達式更複雜，例如需要引用不同表格的聚合時，`CALCULATE` 的顯式上下文轉換行為就變得不可或缺。

## 🛠️ 進階 DAX 應用範例 (結合上下文)

### 範例 1：計算超過目標的銷售額
```dex
超標銷售額 =
VAR 目標銷售額 = 1000000 // 假設目標值
VAR 實際銷售額 = [總銷售額]

RETURN
    CALCULATE(
        實際銷售額,
        FILTER(
            ALLSELECTED('銷售表'), // 移除當前視覺化選擇的篩選，重新評估所有銷售額
            實際銷售額 > 目標銷售額 // 在移除篩選後的上下文，再根據新的條件篩選
        )
    )
```

- 這個例子利用 `CALCULATE` 和 `FILTER` 來重新評估總銷售額，並僅在總銷售額超過目標時才納入計算，這在分析達成率時非常有用。
- `ALLSELECTED` 則移除視覺化層級的篩選，但保留其他頁面或報表層級的篩選。

### 範例 2：計算不同產品類別的總銷售額 (忽略產品名稱篩選)

```dex
總銷售額_忽略產品名稱 =
CALCULATE(
    [總銷售額],
    REMOVEFILTERS('產品表'[產品名稱]) // 移除 '產品表' 中 '產品名稱' 欄位上的所有篩選
)
```

這個度量值無論用戶選擇哪個產品名稱，都會顯示該產品所屬類別的總銷售額，而不是單一產品的銷售額。這對於比較同類別下各產品的銷售表現非常實用。

---
## ⚠️ 實務注意事項

- **掌握 `CALCULATE`**：它是 DAX 的核心，花時間理解其運作機制（特別是它如何處理篩選和上下文轉換）是學習進階 DAX 的必經之路。

- **小心行上下文與篩選上下文的互動**：當在行上下文中使用聚合函數或 `CALCULATE` 時，務必理解上下文轉換的影響。

- **利用變數簡化複雜邏輯**：如同先前筆記所強調，變數能讓複雜的上下文操作變得更易讀和高效。

- **多練習，多實驗**：DAX 的學習需要大量的實踐。嘗試在 Power BI Desktop 中撰寫各種 DAX 公式，觀察其結果，並利用 DAX Studio 等工具來檢查公式的評估步驟和效能。

- **理解隱式和顯式篩選**：報表的切片器、視覺化元素會產生隱式篩選上下文，而 `CALCULATE` 則允許你顯式地添加、移除或修改這些篩選。

---
## 🔗 相關卡片

- [[010.5-PowerBI-DAX 基礎語法]]
- [[010.6-PowerBI-互動功能與篩選器]]
- [[010.8-PowerBI-資料建模與關聯]] (良好的資料模型是高效 DAX 的基礎)
- [[010.10-PowerBI-DAX 時間智慧函數]] (時間智慧函數大量依賴於 `CALCULATE` 和上下文)