---
title: 🧮 010.10-PowerBI-DAX 時間智慧函數
tags:
  - PowerBI
  - DAX
  - 時間智慧
  - BI工具
  - 日期分析
aliases:
  - DAX 時間函數
  - 時間智能
  - Date Table
created: 2025-07-08
updated: 2025-07-08
status: 完成
summary: 深入探討 DAX 中的時間智慧函數，包括其工作原理、常用函數介紹、應用場景，以及正確使用時間智慧函數的關鍵前提——日期表。
---

## 🧮 什麼是 DAX 時間智慧函數？

在商業分析中，時間是一個極為重要的維度。我們經常需要比較不同時期的數據，例如：「去年同期銷售額是多少？」「本月累計銷售額是多少？」「與上一個季度相比，這個季度增長了多少？」

**DAX 時間智慧函數 (Time Intelligence Functions)** 就是為了解決這些常見的時間相關分析而設計的。它們是一組特別的 DAX 函數，能夠方便地移動和操作篩選上下文中的時間點，從而實現：

* **期間比較**：例如與去年同期、上一個月、上一個季度進行比較。
* **累計計算**：例如年初至今 (YTD)、季度至今 (QTD)、月至今 (MTD) 的累計值。
* **滾動計算**：例如過去 30 天的平均值。

這些函數的強大之處在於，它們能自動處理複雜的日期篩選邏輯，讓你在撰寫時間相關的分析指標時，公式更簡潔、更不易出錯。

---

## 💡 使用時間智慧函數的關鍵前提：日期表 (Date Table)

要讓 DAX 時間智慧函數發揮作用，你的 Power BI 資料模型中必須有一個**正確的日期表 (Date Table)**。這是一個**強制性要求**，也是許多人使用時間智慧函數時常遇到的問題點。

### 日期表的必要性：

想像時間軸就像一條連續的河流。日期表提供了這條河流上所有的「航標」和「里程碑」，讓 DAX 時間智慧函數知道如何精確地在時間上進行導航。

一個合格的日期表必須滿足以下條件：

1.  **專屬的日期表**：模型中需要有一個獨立的表格，專門用來存放日期資訊。
2.  **唯一的日期欄位**：這個表格必須有一個包含**唯一日期值**的欄位（通常命名為 `Date` 或 `日期`）。這個欄位應該是日期或日期時間資料型別。
3.  **連續的日期**：日期欄位中的所有日期必須是**連續的**，不能有任何缺失（即使某天沒有銷售，日期也必須存在）。日期範圍應涵蓋你所有數據的最小日期到最大日期。
4.  **標記為日期資料表**：在 Power BI Desktop 中，右鍵點擊該日期表，選擇「**標記為日期資料表 (Mark as date table)**」，並選擇作為日期鍵的欄位。這會告知 Power BI 引擎，這個表是專門用來處理時間智慧計算的。
5.  **與事實表建立關聯**：日期表的日期欄位必須與你的事實表（如銷售表、訂單表）中的日期欄位建立**一對多 (One-to-Many)** 的關係。通常是單向篩選（日期表篩選事實表）。

### 如何建立日期表？

你可以手動建立一個簡單的日期表，或使用 Power Query (M 語言) 或 DAX 來動態生成。

**使用 DAX 生成日期表範例：**

```dax
日期表 =
CALENDAR(MIN('銷售表'[訂單日期]), MAX('銷售表'[訂單日期])) // 生成從最小訂單日期到最大訂單日期之間的所有連續日期
```

然後為這個新生成的 `日期表` 添加年、月、季等輔助欄位，並將其標記為日期資料表。

---
## 🔑 常用 DAX 時間智慧函數分類

DAX 的時間智慧函數種類繁多，但通常可以歸納為幾大類：

### 1. 期間比較函數 (Period-over-Period)

這些函數用於將當前期間與另一個指定期間的數據進行比較。
- **`SAMEPERIODLASTYEAR(<日期欄位>)`**：
    - 返回一個表格，其中包含與當前篩選上下文中的日期相同但**去年**的日期。
    - **範例**：
```dex
去年同期銷售 = CALCULATE([總銷售額], SAMEPERIODLASTYEAR('日期表'[日期]))
```

**`DATEADD(<日期欄位>, <間隔數量>, <間隔>)`**：
- 返回一個表格，其中包含從當前日期起，向前或向後移動指定間隔數量的日期。
- `<間隔>` 可以是 `YEAR`, `QUARTER`, `MONTH`, `DAY`。
- **範例**：
```dex
上個月銷售額 = CALCULATE([總銷售額], DATEADD('日期表'[日期], -1, MONTH))

過去30天銷售額 = CALCULATE([總銷售額], DATEADD('日期表'[日期], -30, DAY))
```

**`PARALLELPERIOD(<日期欄位>, <間隔數量>, <間隔>)`**：

- 返回一個包含與指定間隔（年、季、月）平行的日期的表格。與 `DATEADD` 相似，但通常用於獲取完整期間。

- **範例**：
```dex
上季銷售額 = CALCULATE([總銷售額], PARALLELPERIOD('日期表'[日期], -1, QUARTER))
```

### 2. 累計計算函數 (Running Totals / Year-to-Date)

這些函數用於計算從某個時間點（如年初、季初、月初）至今的累計值。

- **`TOTALYTD(<表達式>, <日期欄位>, [<篩選>], [<年份結束日期>])`**：
    - 計算從會計年度開始到當前篩選上下文結束為止的累計值（Year-to-Date）。
    - **範例**：
```dex
年度累計銷售 = TOTALYTD([總銷售額], '日期表'[日期])
```

**`TOTALQTD(<表達式>, <日期欄位>, [<篩選>])`**：
- 季度累計值（Quarter-to-Date）。
- **範例**：
```dex
季度累計銷售 = TOTALQTD([總銷售額], '日期表'[日期])
```

### 3. 期初/期末日期函數 (Start/End of Period)

這些函數用於獲取指定期間的開始或結束日期。

- **`STARTOFMONTH(<日期欄位>)`, `ENDOFMONTH(<日期欄位>)`**
- **`STARTOFQUARTER(<日期欄位>)`, `ENDOFQUARTER(<日期欄位>)`**
- **`STARTOFYEAR(<日期欄位>)`, `ENDOFYEAR(<日期欄位>)`**

- **範例**：
```dex
當月第一天 = STARTOFMONTH('日期表'[日期])
```
這些通常會與 `CALCULATE` 函數結合使用。

### 4. 其他常用函數

- **`DATESBETWEEN(<日期欄位>, <開始日期>, <結束日期>)`**：
    - 返回兩個日期之間的所有日期，常用於自定義區間。
    - **範例**：
```dex
過去90天銷售 = CALCULATE([總銷售額], DATESBETWEEN('日期表'[日期], TODAY()-90, TODAY()))
```

- **`DATESINPERIOD(<日期欄位>, <開始日期>, <間隔數量>, <間隔>)`**：
	- 返回從指定開始日期起，指定間隔數量和間隔的所有日期。
	- **範例**：
```dex
本月銷售額 = CALCULATE([總銷售額], DATESINPERIOD('日期表'[日期], LASTDATE('日期表'[日期]), 0, MONTH))
```

---
## 🛠️ 時間智慧函數的應用範例 (綜合)

假設我們有一個度量值 `[總銷售額]`。

### 範例 1：計算同比增長率 (Year-over-Year Growth)
```dex
銷售 YoY 增長率 =
VAR 今年銷售 = [總銷售額]
VAR 去年銷售 = CALCULATE([總銷售額], SAMEPERIODLASTYEAR('日期表'[日期]))
RETURN
    DIVIDE(今年銷售 - 去年銷售, 去年銷售, BLANK()) // 如果去年銷售為零，返回空白
```

### 範例 2：計算年初至今的成長情況
```dex
YTD 銷售額 = TOTALYTD([總銷售額], '日期表'[日期])

YTD 銷售額去年同期 = CALCULATE(
    [YTD 銷售額],
    SAMEPERIODLASTYEAR('日期表'[日期])
)
```

### 範例 3：計算月平均銷售額 (假設按天或週數據)
```dex
月平均銷售額 =
VAR 當月天數 = COUNTROWS(DATESINPERIOD('日期表'[日期], LASTDATE('日期表'[日期]), 0, MONTH))
RETURN
    DIVIDE([總銷售額], 當月天數, BLANK())
```

---
## ⚠️ 實務注意事項

- **日期表的中心地位**：所有時間智慧函數都依賴於模型中**唯一且正確標記的日期表**。這是最常出錯的地方，請務必確認。

- **與 `CALCULATE` 結合**：時間智慧函數通常作為 `CALCULATE` 函數的篩選引數，來改變篩選上下文，從而計算特定時間段的指標。

- **理解篩選上下文**：時間智慧函數會生成日期表中的日期子集，然後將這些日期作為篩選條件應用到當前的篩選上下文。

- **處理未來日期**：如果你的日期表包含未來日期，時間智慧函數可能會將未來日期納入計算。在某些情況下，你可能需要額外的篩選來排除未來日期。

- **會計年度**：如果你的會計年度與日曆年不同（例如 7 月 1 日開始），可以在 `TOTALYTD` 等函數中指定 `年份結束日期` 參數。


時間智慧函數是 Power BI 中進行深入時間序列分析的強大武器。一旦掌握了日期表的建立和這些函數的應用，就能為你的報表帶來更豐富的商業洞察。

---
## 🔗 相關卡片

- [[010.3-PowerBI-資料模型與關聯]] (日期表與事實表的關係)
- [[010.5-PowerBI-DAX 基礎語法]]
- [[010.9-PowerBI-DAX 進階計算與上下文轉換]] (時間智慧函數是 `CALCULATE` 應用的一個重要子集)
- [[010.11-PowerBI-效能優化與最佳實踐]] (優化日期表和時間智慧函數的效能)