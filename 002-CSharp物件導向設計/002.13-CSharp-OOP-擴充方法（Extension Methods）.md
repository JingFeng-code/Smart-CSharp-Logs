---
title: ğŸ§µ 001.13-CSharp-éåŒæ­¥éŒ¯èª¤è™•ç†èˆ‡å–æ¶ˆ Token  
tags:
- C#
- éåŒæ­¥
- async
- await
- Task
- éŒ¯èª¤è™•ç†
- CancellationToken  
aliases:
- C# async ä¾‹å¤–è™•ç†
- C# éåŒæ­¥å–æ¶ˆä»»å‹™
- async cancel æ•™å­¸  
created: 2025-07-24  
updated: 2025-07-24  
status: è‰ç¨¿  
summary: æœ¬ç¯‡ç­†è¨˜èªªæ˜ C# éåŒæ­¥ç¨‹å¼ä¸­çš„éŒ¯èª¤è™•ç†æŠ€å·§èˆ‡ä»»å‹™å–æ¶ˆæ©Ÿåˆ¶ï¼ŒåŒ…æ‹¬ try/catch/finally çš„ä½¿ç”¨æ–¹å¼ã€å¦‚ä½•å‚³é CancellationTokenã€å¯¦ä½œç”¨æˆ¶å–æ¶ˆä¸‹è¼‰ç­‰æƒ…å¢ƒï¼Œå¹«åŠ©ä½ ç·¨å¯«ç©©å®šä¸”å¯æ§çš„ async ç¨‹å¼ç¢¼ã€‚
---


## ğŸ“˜ æœ¬ç¯‡é‡é»ç´¢å¼•

- éåŒæ­¥éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ï¼ˆtry/catchï¼‰

- Task ä¸¦è¡Œæ™‚çš„ä¾‹å¤–å‚³æ’­

- ä½¿ç”¨ `CancellationToken` å–æ¶ˆä»»å‹™

- å¯¦ä½œå¯å–æ¶ˆçš„é•·æ™‚é–“ä½œæ¥­ï¼ˆå¦‚ä¸‹è¼‰ / ç­‰å¾…ï¼‰

- GUI / Console çš„å–æ¶ˆæŒ‰éˆ•ç¯„ä¾‹

---

## 1ï¸âƒ£ async/await è£¡çš„éŒ¯èª¤è™•ç†æ€éº¼åšï¼Ÿ

```csharp
try
{
    await DangerousWorkAsync();
}
catch (Exception ex)
{
    Console.WriteLine($"éŒ¯èª¤ï¼š{ex.Message}");
}
finally
{
    Console.WriteLine("ä¸è«–æ˜¯å¦å‡ºéŒ¯éƒ½æœƒåŸ·è¡Œ");
}
```

âœ… åªè¦ç”¨ awaitï¼ŒéŒ¯èª¤å°±æœƒã€Œæ‹‹å‡ºã€åˆ°å‘¼å«ç«¯  
âœ… ç”¨ try/catch åŒ…è£¹ await å€æ®µå³å¯æ””æˆª

ğŸ“Œ è‹¥æ˜¯ `Task.WhenAll(...)`ï¼Œ**è¦ç‰¹åˆ¥è™•ç†ä¾‹å¤–é›†åˆ**ï¼ˆè¦‹ä¸‹ç¯€ï¼‰

---
## 2ï¸âƒ£ å¤šä»»å‹™éŒ¯èª¤è™•ç†ï¼š`Task.WhenAll` æœƒä¸Ÿ AggregateException

```csharp
try
{
    await Task.WhenAll(FailAAsync(), FailBAsync());
}
catch (Exception ex)
{
    Console.WriteLine($"æ•æ‰éŒ¯èª¤ï¼š{ex.Message}");
}
```

ğŸ” å¯¦éš›ä¸Š .NET å…§éƒ¨æœƒç”¨ `AggregateException` åŒ…è£å¤šå€‹éŒ¯èª¤  
ä½† `await` æœƒå¹«ä½ ã€Œè‡ªå‹•æ”¤å¹³ã€ï¼Œåªæœƒæ•æ‰ç¬¬ä¸€å€‹

ğŸ“Œ è‹¥è¦å–å‡ºæ‰€æœ‰éŒ¯èª¤å…§å®¹ï¼š

```csharp
catch (AggregateException agex)
{
    foreach (var e in agex.InnerExceptions)
        Console.WriteLine($"éŒ¯èª¤ï¼š{e.Message}");
}
```

---
## 3ï¸âƒ£ ä»€éº¼æ˜¯ CancellationTokenï¼Ÿ

ğŸ‘‰ ä¸€ç¨® **å‚³éå–æ¶ˆè«‹æ±‚çš„æ–¹å¼**ï¼Œè®“ç¨‹å¼å¯ä»¥ã€Œæœ‰ç¦®è²Œåœ°ã€ä¸­æ­¢ä½œæ¥­ï¼š

```csharp
var cts = new CancellationTokenSource();
CancellationToken token = cts.Token;
```

ä½ å¯ä»¥å°‡é€™å€‹ token å‚³å…¥æ–¹æ³•ï¼Œä¸¦åœ¨æ–¹æ³•ä¸­å®šæœŸæª¢æŸ¥ï¼š

```csharp
public async Task LongWorkAsync(CancellationToken token)
{
    for (int i = 0; i < 5; i++)
    {
        token.ThrowIfCancellationRequested();
        await Task.Delay(1000);
    }
}
```

âœ… `ThrowIfCancellationRequested()` æœƒä¸»å‹•æ‹‹å‡º OperationCanceledException

---
## 4ï¸âƒ£ å¦‚ä½•å–æ¶ˆä»»å‹™ï¼Ÿ

```csharp
var cts = new CancellationTokenSource();
var task = LongWorkAsync(cts.Token);

// 3 ç§’å¾Œå–æ¶ˆ
Task.Delay(3000).ContinueWith(t => cts.Cancel());

try
{
    await task;
}
catch (OperationCanceledException)
{
    Console.WriteLine("å·¥ä½œå·²è¢«å–æ¶ˆï¼");
}
```

---
## 5ï¸âƒ£ ç¯„ä¾‹ï¼šGUI çš„å–æ¶ˆæŒ‰éˆ•ï¼ˆWinForms/WPFï¼‰

```csharp
private CancellationTokenSource _cts;

private async void btnStart_Click(object sender, EventArgs e)
{
    _cts = new CancellationTokenSource();
    try
    {
        await LongOperationAsync(_cts.Token);
    }
    catch (OperationCanceledException)
    {
        MessageBox.Show("å·²å–æ¶ˆä½œæ¥­");
    }
}

private void btnCancel_Click(object sender, EventArgs e)
{
    _cts?.Cancel();
}
```

---
## 6ï¸âƒ£ å°æŠ€å·§èˆ‡å¸¸è¦‹èª¤å€

|å•é¡Œ|å»ºè­°åšæ³•|
|---|---|
|ä¸çŸ¥é“ä»»å‹™æ˜¯å¦å–æ¶ˆ|catch OperationCanceledException|
|æƒ³å–æ¶ˆå¾Œæ¸…ç†è³‡æº|ç”¨ finally å€æ®µåšæ”¶å°¾|
|å¤šå€‹ä»»å‹™å…±ç”¨å–æ¶ˆæ¬Šé™|æŠŠ `token` å‚³çµ¦å¤šå€‹å­ä»»å‹™|
|è¨˜å¾—å®šæœŸæª¢æŸ¥ token|ç”¨ `ThrowIfCancellationRequested()` æˆ–æ‰‹å‹• if åˆ¤æ–·|
|UI éœ€ disable å–æ¶ˆæŒ‰éˆ•|å¯ä»¥åœ¨ finally è£¡é‚„åŸæŒ‰éˆ•ç‹€æ…‹|

---
## âœ… å°çµ

- `try/catch` å¯æ­£ç¢ºè™•ç† async ä¸­ç™¼ç”Ÿçš„ä¾‹å¤–

- å¤šå€‹ Task å»ºè­°ç”¨ `WhenAll` + `try/catch` åŒ…è£¹æ•´é«”

- ä½¿ç”¨ `CancellationToken` å¯è®“ä½ å„ªé›…ä¸­æ­¢éåŒæ­¥ä½œæ¥­

- GUI / Console éƒ½èƒ½å¯¦ä½œã€Œå–æ¶ˆä¸­é•·ä»»å‹™ã€çš„åŠŸèƒ½

- åŠ å…¥éŒ¯èª¤èˆ‡å–æ¶ˆè™•ç†ï¼Œè®“ä½ çš„ async ç¨‹å¼æ›´ç©©å¥

---
## ğŸ”— å»¶ä¼¸é–±è®€

- [[001.11-CSharp-éåŒæ­¥ç¨‹å¼è¨­è¨ˆï¼ˆasync_awaitï¼‰]]
- [[001.12-CSharp-éåŒæ­¥èˆ‡ Task ä¸¦è¡Œè™•ç†]]
- [CancellationToken èªªæ˜æ–‡ä»¶](https://learn.microsoft.com/zh-tw/dotnet/api/system.threading.cancellationtoken)
- [OperationCanceledException æ–‡ä»¶](https://learn.microsoft.com/zh-tw/dotnet/api/system.operationcanceledexception)